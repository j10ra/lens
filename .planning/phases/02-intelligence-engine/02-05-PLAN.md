---
phase: 02-intelligence-engine
plan: "05"
type: execute
wave: 5
depends_on: ["02-04"]
files_modified:
  - apps/daemon/src/routes/repos.ts
  - apps/daemon/src/routes/grep.ts
  - apps/daemon/src/http.ts
  - apps/daemon/src/index.ts
  - apps/daemon/src/mcp.ts
  - apps/daemon/package.json
autonomous: true
requirements: [DAEM-05, DAEM-06]

must_haves:
  truths:
    - "POST /repos registers a repo and returns the repo record with 201 status"
    - "GET /repos returns all registered repos"
    - "DELETE /repos/:id removes a repo and cascades deletes"
    - "POST /repos/:id/index triggers indexing and returns IndexResult"
    - "POST /grep calls grepRepo() from @lens/engine and returns enriched results (not stub)"
    - "configureEngineDb() called in daemon startup alongside existing configure*() calls"
    - "MCP lens_grep tool calls /grep which now returns real engine results"
  artifacts:
    - path: "apps/daemon/src/routes/repos.ts"
      provides: "Repo CRUD routes: POST /, GET /, DELETE /:id, POST /:id/index"
      contains: "lensRoute"
    - path: "apps/daemon/src/routes/grep.ts"
      provides: "Updated grep route calling real engine"
      contains: "grepRepo"
    - path: "apps/daemon/src/http.ts"
      provides: "Updated route mounting with /repos"
      contains: "reposRoutes"
    - path: "apps/daemon/src/index.ts"
      provides: "Engine DB initialization at startup"
      contains: "configureEngineDb"
  key_links:
    - from: "apps/daemon/src/routes/repos.ts"
      to: "packages/engine"
      via: "registerRepo, removeRepo, listRepos, runIndex imports"
      pattern: "from.*@lens/engine"
    - from: "apps/daemon/src/routes/grep.ts"
      to: "packages/engine"
      via: "grepRepo import"
      pattern: "from.*@lens/engine"
    - from: "apps/daemon/src/index.ts"
      to: "packages/engine"
      via: "configureEngineDb import"
      pattern: "configureEngineDb"
    - from: "apps/daemon/src/http.ts"
      to: "apps/daemon/src/routes/repos.ts"
      via: "app.route('/repos', reposRoutes)"
      pattern: "reposRoutes"
---

<objective>
Daemon route wiring — repo CRUD, index trigger, and real grep — connecting the engine to HTTP and MCP consumers.

Purpose: Wires the `@lens/engine` package into the daemon's HTTP routes. Adds repo management endpoints (register, list, remove, reindex), replaces the grep stub with real engine calls, and initializes the engine DB at daemon startup. After this plan, `lens grep` via MCP or CLI returns real structural results.
Output: Working daemon API: `/repos` CRUD, `/repos/:id/index`, `/grep` with real engine.
</objective>

<execution_context>
@/Users/jalipalo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jalipalo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-intelligence-engine/02-RESEARCH.md
@.planning/phases/01-core-daemon-mcp/01-02-SUMMARY.md
@.planning/phases/02-intelligence-engine/02-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Repo management routes + daemon startup wiring</name>
  <files>
    apps/daemon/src/routes/repos.ts
    apps/daemon/src/http.ts
    apps/daemon/src/index.ts
    apps/daemon/package.json
  </files>
  <action>
**package.json** — Add `@lens/engine` as workspace dependency: `"@lens/engine": "workspace:*"`. Run `pnpm install`.

**repos.ts** — New file. All routes wrapped in `lensRoute()` (daemon convention from Phase 1):

```typescript
import { lensRoute } from "@lens/core";
import { Hono } from "hono";
import { getEngineDb, registerRepo, removeRepo, listRepos, runIndex } from "@lens/engine";
```

Routes:
- `POST /` — Register a repo. Body: `{ path: string, name?: string }`. Call `registerRepo(getEngineDb(), path, name)`. Return 201 with repo record. Catch errors (not a git repo → 400).
- `GET /` — List all repos. Call `listRepos(getEngineDb())`. Return 200 with array.
- `DELETE /:id` — Remove a repo. Call `removeRepo(getEngineDb(), id)`. Return 200 with `{ removed: true }`. If not found, return 404.
- `POST /:id/index` — Trigger reindex. Body: `{ force?: boolean }` (default false). Call `await runIndex(getEngineDb(), id, force)`. Return 200 with IndexResult. If repo not found, return 404. If already indexing, the mutex in runIndex will queue it — no special handling needed.

All handlers use `lensRoute("repos.register", ...)`, `lensRoute("repos.list", ...)`, etc.

**http.ts** — Mount repos routes:
- Add `import { reposRoutes } from "./routes/repos.js";`
- Add `app.route("/repos", reposRoutes);` after existing route mounts.

**index.ts** — Add engine DB initialization:
- Add `import { configureEngineDb } from "@lens/engine";`
- Add `const INDEX_DB = join(DATA_DIR, "index.db");` after TRACE_DB.
- Add `configureEngineDb(INDEX_DB);` after the configure*() calls and before startHttpServer().
- This ensures the engine DB is ready before any route handler tries to use it.

**tsup.config.ts** — Add `@lens/engine` to externals (alongside `@lens/core`). Workspace packages ship their own builds and must not be rebundled.
  </action>
  <verify>
    `pnpm install` succeeds (workspace dependency resolved).
    `pnpm --filter @lens/daemon build` succeeds.
    `pnpm --filter @lens/daemon typecheck` exits 0.
    `grep -r "lensRoute" apps/daemon/src/routes/repos.ts` confirms all handlers wrapped.
    `grep -r "configureEngineDb" apps/daemon/src/index.ts` confirms DB init at startup.
    `grep -r "reposRoutes" apps/daemon/src/http.ts` confirms route mounting.
  </verify>
  <done>
    Repo CRUD routes (POST/GET/DELETE /repos, POST /repos/:id/index) wired with lensRoute() (DAEM-05, DAEM-06). Engine DB initialized at daemon startup. @lens/engine added as workspace dependency and externalized in tsup.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire grep route to real engine + update MCP tool</name>
  <files>
    apps/daemon/src/routes/grep.ts
    apps/daemon/src/mcp.ts
  </files>
  <action>
**grep.ts** — Replace the stub with real engine call:

```typescript
import { lensRoute } from "@lens/core";
import { Hono } from "hono";
import { getEngineDb, grepRepo } from "@lens/engine";

export const grepRoutes = new Hono();

grepRoutes.post("/", lensRoute("grep.post", async (c) => {
  const { repoPath, query, limit = 20 } = await c.req.json();

  // Find repo by path — need to resolve repoPath to repoId
  // Import listRepos or add a getRepoByPath query
  const db = getEngineDb();
  // Look up repo by root_path
  const repos = await listRepos(db);
  const repo = repos.find(r => r.root_path === repoPath || r.root_path === repoPath.replace(/\/$/, ""));

  if (!repo) {
    return c.json({
      error: "Repo not registered",
      hint: "Register with POST /repos { path: \"...\" } then POST /repos/:id/index",
    }, 404);
  }

  if (repo.index_status !== "ready") {
    return c.json({
      error: "Repo not indexed",
      hint: `Index status: ${repo.index_status}. Trigger with POST /repos/${repo.id}/index`,
    }, 409);
  }

  const result = await grepRepo(db, repo.id, query, limit);
  return c.json(result);
}));
```

Note: The route needs to resolve `repoPath` (absolute path from the caller) to a `repoId` (internal DB id). Use `listRepos()` and find by `root_path` match. Alternatively, add a `getRepoByPath(db, path)` query to queries.ts in the engine package. The simpler approach (find in list) is fine for Phase 2 — Phase 4 hardening can optimize if needed.

Also import `listRepos` from `@lens/engine`.

**mcp.ts** — The MCP tool already calls `fetch(DAEMON_URL/grep)` which now returns real results. No changes needed to the MCP code itself — it's already a gate that calls the daemon HTTP endpoint. The response format from the updated grep route matches what the MCP tool forwards.

However, verify that the MCP tool's response formatting still works with the enriched result shape. The current MCP handler does `JSON.stringify(data, null, 2)` which handles any JSON object — no changes needed.

Optional improvement (if time permits): Add a `lens_register` tool and `lens_index` tool to MCP so agents can register and index repos directly. But this is Phase 3 scope (CLI-02 handles full CLI commands) — skip for now. Document in summary that MCP currently only has `lens_grep`.
  </action>
  <verify>
    `pnpm --filter @lens/daemon build` succeeds.
    `pnpm --filter @lens/daemon typecheck` exits 0.
    `grep -r "grepRepo" apps/daemon/src/routes/grep.ts` confirms real engine call (not stub).
    `grep -r "Phase 2 wires real engine" apps/daemon/src/routes/grep.ts` returns 0 matches (stub comment removed).
    Start daemon: `LENS_MCP=false node apps/daemon/dist/index.js &`
    End-to-end test sequence:
    1. `curl -s http://localhost:4111/health | jq .` → status ok
    2. `curl -s -X POST http://localhost:4111/repos -H 'Content-Type: application/json' -d '{"path":"/path/to/this/repo"}' | jq .` → 201 with repo record
    3. `curl -s http://localhost:4111/repos | jq .` → array with 1 repo
    4. `curl -s -X POST http://localhost:4111/repos/{id}/index -H 'Content-Type: application/json' -d '{}' | jq .` → IndexResult with files_scanned > 0
    5. `curl -s -X POST http://localhost:4111/grep -H 'Content-Type: application/json' -d '{"repoPath":"/path/to/this/repo","query":"lensFn|lensRoute"}' | jq .` → enriched results with importers, cochangePartners, isHub
    6. `curl -s -X DELETE http://localhost:4111/repos/{id} | jq .` → removed true
    Kill daemon after testing.
  </verify>
  <done>
    POST /grep calls real grepRepo() from @lens/engine (not stub). Returns enriched results with importers, co-change partners, hub status, exports, docstring. MCP lens_grep tool works end-to-end (calls /grep which now returns real data). Repo not registered → 404 with helpful hint. Repo not indexed → 409 with hint.
  </done>
</task>

</tasks>

<verification>
- `pnpm -r build` exits 0 (all packages build)
- `pnpm --filter @lens/daemon typecheck` exits 0
- End-to-end: register repo → index → grep returns enriched results with structural metadata
- `grep -r "grepRepo\|registerRepo\|removeRepo\|listRepos\|runIndex" apps/daemon/src/routes/` confirms engine integration
- `grep -r "configureEngineDb" apps/daemon/src/index.ts` confirms startup wiring
- `grep -r "lensRoute" apps/daemon/src/routes/repos.ts` confirms all handlers traced
</verification>

<success_criteria>
- All 4 repo management endpoints work (DAEM-05): POST /repos, GET /repos, DELETE /repos/:id, POST /repos/:id/index (DAEM-06)
- POST /grep returns real engine results (not stub)
- Engine DB initialized at daemon startup
- MCP lens_grep tool returns real results via /grep
- End-to-end flow works: register → index → grep → enriched structural results
</success_criteria>

<output>
After completion, create `.planning/phases/02-intelligence-engine/02-05-SUMMARY.md`
</output>
