---
phase: 02-intelligence-engine
plan: "02"
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - packages/engine/src/index/imports.ts
  - packages/engine/src/index/import-graph.ts
  - packages/engine/src/index/git-analysis.ts
autonomous: true
requirements: [ENGN-03, ENGN-04]

must_haves:
  truths:
    - "extractImportSpecifiers() extracts import paths from TypeScript/JavaScript source using regex"
    - "resolveImport() resolves relative import specifiers to repo-relative file paths"
    - "buildAndPersistImportGraph() merges chunks per file, extracts imports, resolves paths, writes edges to fileImports table"
    - "analyzeGitHistory() parses git log --name-only, computes per-file commit counts and pairwise co-change frequencies"
    - "Co-change analysis skips merge commits (--no-merges) and commits touching >20 files"
  artifacts:
    - path: "packages/engine/src/index/imports.ts"
      provides: "extractImportSpecifiers(), resolveImport()"
      exports: ["extractImportSpecifiers", "resolveImport"]
    - path: "packages/engine/src/index/import-graph.ts"
      provides: "buildAndPersistImportGraph()"
      exports: ["buildAndPersistImportGraph"]
    - path: "packages/engine/src/index/git-analysis.ts"
      provides: "analyzeGitHistory()"
      exports: ["analyzeGitHistory"]
  key_links:
    - from: "packages/engine/src/index/import-graph.ts"
      to: "packages/engine/src/index/imports.ts"
      via: "extractImportSpecifiers() + resolveImport() calls"
      pattern: "extractImportSpecifiers|resolveImport"
    - from: "packages/engine/src/index/import-graph.ts"
      to: "packages/engine/src/db/queries.ts"
      via: "importQueries.insertEdges()"
      pattern: "importQueries"
    - from: "packages/engine/src/index/git-analysis.ts"
      to: "packages/engine/src/db/queries.ts"
      via: "statsQueries.upsertStats() + cochangeQueries.upsertPairs()"
      pattern: "statsQueries|cochangeQueries"
---

<objective>
Import graph construction and git co-change analysis — the two structural signals that differentiate LENS from plain text search.

Purpose: Import graph provides the "who imports whom" edges for indegree scoring and reverse import lookups. Co-change analysis provides the "files that change together" signal from git history. Both signals feed into the composite scorer (Plan 02-03).
Output: `imports.ts`, `import-graph.ts`, `git-analysis.ts` — all writing to the engine DB tables defined in Plan 02-01.
</objective>

<execution_context>
@/Users/jalipalo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jalipalo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-intelligence-engine/02-RESEARCH.md
@.planning/phases/02-intelligence-engine/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Import specifier extraction and import graph builder</name>
  <files>
    packages/engine/src/index/imports.ts
    packages/engine/src/index/import-graph.ts
  </files>
  <action>
**imports.ts** — Port from v1 (`git show v1-archive:packages/engine/src/index/imports.ts` for reference). Regex-based, NOT ts-morph (research decision: regex proven in v1, zero deps, handles TS/JS/Python/Go/Rust):

- `extractImportSpecifiers(content: string, language: string | null): string[]` — Returns raw import specifiers (the string inside quotes). Regex patterns by language:
  - TypeScript/JavaScript/TSX/JSX: `import\s+.*?\s+from\s+['"](.+?)['"]`, `import\s*\(\s*['"](.+?)['"]\s*\)` (dynamic), `require\s*\(\s*['"](.+?)['"]\s*\)`, `export\s+.*?\s+from\s+['"](.+?)['"]` (re-exports)
  - Python: `from\s+(\S+)\s+import`, `import\s+(\S+)`
  - Go: `"(\S+)"`  within import blocks
  - Rust: `use\s+(\S+)`, `mod\s+(\w+)`
  - For unknown languages, try JS/TS patterns (most common in target repos).
  - Filter out node built-in modules (`node:*`), npm packages (no `.` or `/` prefix). Keep only relative imports starting with `.` or `..`.
  - Synchronous, internal helper — do NOT wrap in lensFn().

- `resolveImport(specifier: string, sourceFilePath: string, knownPaths: Set<string>): string | null` — Resolves a relative import specifier to a repo-relative file path.
  - Join `path.dirname(sourceFilePath)` with specifier using `path.posix.resolve()` (use posix for consistent `/` separators).
  - Try extensions in order: exact match, `.ts`, `.tsx`, `.js`, `.jsx`, `/index.ts`, `/index.tsx`, `/index.js`, `/index.jsx`.
  - Return the first path found in `knownPaths` set, or null if unresolvable.
  - Synchronous, internal helper — do NOT wrap in lensFn().

**import-graph.ts** — Port from v1 (`git show v1-archive:packages/engine/src/index/import-graph.ts`):

- `buildAndPersistImportGraph(db: Db, repoId: string): void` — Synchronous (called from runIndex which is already lensFn-wrapped).
  1. Clear existing import edges for repo: `importQueries.clearForRepo(db, repoId)`
  2. Get all chunks grouped by path: `chunkQueries.getAllPaths(db, repoId)` → for each unique path, get chunks, merge content by sorting on chunk_index and joining.
  3. Build `knownPaths: Set<string>` from all file paths in the repo.
  4. For each file: extract import specifiers from merged content, resolve each specifier against knownPaths, collect `{ sourcePath, targetPath }` edges.
  5. Deduplicate edges (same source→target pair once).
  6. Batch insert edges: `importQueries.insertEdges(db, repoId, edges)`.
  7. Compute and store max_import_depth on the repo row (optional — longest chain in the DAG, useful for Phase 3 visualization). If complex, skip and default to 0.

  **CRITICAL anti-pattern from research:** Do NOT call `extractImportSpecifiers()` per-chunk. Merge chunks per file first, then extract once per file. Chunk boundaries may split import statements.

  Only process files with language in `["typescript", "typescriptreact", "javascript", "javascriptreact", "python", "go", "rust"]`.
  </action>
  <verify>
    `pnpm --filter @lens/engine build` succeeds.
    `pnpm --filter @lens/engine typecheck` exits 0.
    `grep -r "extractImportSpecifiers" packages/engine/src/` shows imports.ts and import-graph.ts.
    `grep -r "resolveImport" packages/engine/src/` shows imports.ts and import-graph.ts.
    `grep -r "clearForRepo" packages/engine/src/index/import-graph.ts` confirms old edges are cleared before rebuild.
  </verify>
  <done>
    Import specifier extraction handles TS/JS/Python/Go/Rust via regex (ENGN-03). Import graph builder merges chunks per file, resolves relative imports against known paths, and persists edges to fileImports table. Edges are deduplicated. Old edges cleared before rebuild.
  </done>
</task>

<task type="auto">
  <name>Task 2: Git co-change analysis</name>
  <files>
    packages/engine/src/index/git-analysis.ts
  </files>
  <action>
**git-analysis.ts** — Port from v1 (`git show v1-archive:packages/engine/src/index/git-analysis.ts`):

- `analyzeGitHistory(db: Db, repoId: string, repoRoot: string, sinceCommit?: string | null): Promise<void>` — Async (uses execFile for git):

  1. Build git log command: `git log --name-only --format=%H%x00%aI --no-merges` (research: `--no-merges` avoids inflated co-change from merge commits). If `sinceCommit` is provided, add `${sinceCommit}..HEAD` to only analyze new commits.
  2. Run via `execFile("git", args, { cwd: repoRoot, maxBuffer: 100*1024*1024 })`.
  3. Parse output into commits: each commit block has `commitHash\0authorDate` on first line, blank line separator, then file paths (one per line). Split on double newlines.
  4. Build per-file stats: `Map<string, { commitCount: number, recentCount: number, lastModified: string }>`. "Recent" = commits within last 90 days.
  5. Build co-change pairs: For each commit, collect file paths. Skip commits touching >20 files (MAX_FILES_PER_COMMIT — prevents monorepo root commits from polluting signal). For remaining commits, generate all unique pairs `(pathA, pathB)` where `pathA < pathB` (lexicographic order for consistent dedup). Accumulate pair counts in a `Map<string, number>` where key is `${pathA}\0${pathB}`.
  6. Filter co-change pairs: Only persist pairs with count >= 2 (MIN_COCHANGE_THRESHOLD — single co-occurrence is noise).
  7. Persist: `statsQueries.upsertStats(db, repoId, statsArray)`, `cochangeQueries.upsertPairs(db, repoId, pairsArray)`.
  8. Update repo row: `repoQueries.updateGitAnalysisCommit(db, repoId, headCommit)` — add this query to queries.ts if not already present. Store the HEAD commit so next analysis can be incremental.

  Constants:
  - `MAX_FILES_PER_COMMIT = 20`
  - `MIN_COCHANGE_THRESHOLD = 2`
  - `RECENT_DAYS = 90`
  </action>
  <verify>
    `pnpm --filter @lens/engine build` succeeds.
    `pnpm --filter @lens/engine typecheck` exits 0.
    `grep -r "no-merges" packages/engine/src/` confirms merge commit filtering.
    `grep -r "MAX_FILES_PER_COMMIT" packages/engine/src/` confirms commit size cap.
    `grep -r "MIN_COCHANGE_THRESHOLD" packages/engine/src/` confirms noise filtering.
  </verify>
  <done>
    Git co-change analysis parses `git log --name-only --no-merges` (ENGN-04). Per-file commit counts and recent counts computed. Pairwise co-change frequencies computed with noise filtering (skip merges, skip large commits, min threshold 2). Results persisted to fileStats and fileCochanges tables. Incremental analysis from last analyzed commit.
  </done>
</task>

</tasks>

<verification>
- `pnpm --filter @lens/engine build` exits 0
- `pnpm --filter @lens/engine typecheck` exits 0
- `grep -r "extractImportSpecifiers\|resolveImport" packages/engine/src/` shows correct files
- `grep -r "no-merges" packages/engine/src/` shows git-analysis.ts
- `grep -r "MAX_FILES_PER_COMMIT\|MIN_COCHANGE_THRESHOLD" packages/engine/src/` shows constants
- `grep -r "clearForRepo" packages/engine/src/index/import-graph.ts` confirms edge cleanup before rebuild
</verification>

<success_criteria>
- Import specifier extraction covers TS/JS/Python/Go/Rust via regex patterns
- Import resolution tries multiple extensions (.ts, .tsx, .js, .jsx, /index.*)
- Import graph builder merges chunks first (never per-chunk extraction)
- Git co-change analysis uses --no-merges and skips commits with >20 files
- Co-change pairs filtered to count >= 2
- Both modules write to the DB tables from Plan 02-01
</success_criteria>

<output>
After completion, create `.planning/phases/02-intelligence-engine/02-02-SUMMARY.md`
</output>
