---
phase: 03-cli-dashboard
plan: 07
type: execute
wave: 4
depends_on: ["03-04", "03-05", "03-06"]
files_modified:
  - apps/daemon/src/http.ts
autonomous: false
requirements: [DAEM-03]

must_haves:
  truths:
    - "Opening http://localhost:4111 in a browser shows the dashboard SPA"
    - "API routes (/health, /repos, /grep, /traces, /stats) still work after serveStatic is added"
    - "SPA client-side routing works — navigating to /repos, /traces returns index.html (not 404)"
    - "Dashboard assets (JS, CSS) load correctly from the daemon server"
  artifacts:
    - path: "apps/daemon/src/http.ts"
      provides: "serveStatic middleware serving dashboard build output with SPA fallback"
      contains: "serveStatic"
  key_links:
    - from: "apps/daemon/src/http.ts"
      to: "apps/dashboard/dist/"
      via: "serveStatic with resolved path"
      pattern: "serveStatic"
---

<objective>
Configure daemon to serve dashboard static files from the built SPA, enabling the dashboard at localhost:4111.

Purpose: Single entry point — users open localhost:4111 and get the dashboard. No separate dev server needed in production.
Output: Daemon serves dashboard dist/ with SPA fallback for client-side routing.
</objective>

<execution_context>
@/Users/jalipalo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jalipalo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-cli-dashboard/03-RESEARCH.md
@.planning/phases/03-cli-dashboard/03-04-SUMMARY.md
@apps/daemon/src/http.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure serveStatic in daemon for dashboard SPA</name>
  <files>
    apps/daemon/src/http.ts
  </files>
  <action>
**1. Add serveStatic to `apps/daemon/src/http.ts`:**

Import `serveStatic` from `@hono/node-server/serve-static` (already installed as dependency of @hono/node-server).

Import `dirname`, `join` from `node:path` and `fileURLToPath` from `node:url`.

Resolve dashboard dist path using ESM-safe approach (research Pitfall 1):
```typescript
// CJS/ESM compat — same pattern used in core/engine packages
declare const __filename: string | undefined;
const _file = typeof __filename !== "undefined" ? __filename : fileURLToPath(import.meta.url);
const DASHBOARD_DIST = process.env.LENS_DASHBOARD_DIST
  ?? join(dirname(_file), "../../../apps/dashboard/dist");
```

**CRITICAL: API routes MUST be mounted BEFORE serveStatic** (research Pitfall 1 — serveStatic wildcard intercepts all requests).

After ALL existing API routes (health, repos, grep, traces, stats), add:

```typescript
// Dashboard static files — AFTER all API routes
app.get("*", serveStatic({ root: DASHBOARD_DIST }));
// SPA fallback: unmatched GET routes serve index.html (client-side router handles /repos, /traces, etc.)
app.get("*", serveStatic({ path: join(DASHBOARD_DIST, "index.html") }));
```

Note: `serveStatic` from `@hono/node-server/serve-static` uses `root` option (directory) for serving files by path match, and `path` option (single file) for the fallback. Check the actual API — `@hono/node-server` v1.x `serveStatic({ root })` expects a relative path or absolute path, and the middleware looks for files relative to root. If the API uses `rewriteRequestPath`, configure accordingly.

**Alternative if serveStatic API differs:**
Use Hono's `c.env` or manually serve files:
```typescript
import { readFile } from "node:fs/promises";
import { extname } from "node:path";

const MIME: Record<string, string> = {
  ".html": "text/html", ".js": "application/javascript",
  ".css": "text/css", ".svg": "image/svg+xml",
  ".json": "application/json", ".png": "image/png",
};

app.get("*", async (c) => {
  const urlPath = new URL(c.req.url).pathname;
  const filePath = join(DASHBOARD_DIST, urlPath === "/" ? "index.html" : urlPath);
  try {
    const content = await readFile(filePath);
    const ext = extname(filePath);
    return new Response(content, { headers: { "content-type": MIME[ext] ?? "application/octet-stream" } });
  } catch {
    // SPA fallback — serve index.html for unmatched paths
    const html = await readFile(join(DASHBOARD_DIST, "index.html"));
    return new Response(html, { headers: { "content-type": "text/html" } });
  }
});
```

Use whichever approach compiles and works. The serveStatic approach is preferred (less code), but the manual approach is the fallback.

**2. Add CORS headers for development:**
When `LENS_MCP=false` (dev mode), add permissive CORS so the Vite dev server (port 5173) can call daemon (port 4111):
```typescript
import { cors } from "hono/cors";
app.use("*", cors()); // permissive for local dev
```
This allows the dashboard dev server to call the daemon API during development. In production (dashboard served by daemon), CORS is not needed but harmless.

**3. Build integration note:**
The dashboard must be built BEFORE the daemon can serve it. Add a note in action but do NOT create build scripts — the user runs `pnpm --filter @lens/dashboard build` then starts the daemon. The `LENS_DASHBOARD_DIST` env var allows overriding the path.
  </action>
  <verify>
1. `pnpm --filter @lens/daemon build` succeeds
2. `pnpm --filter @lens/dashboard build` produces dist/index.html
3. Start daemon with `LENS_MCP=false node apps/daemon/dist/index.js`
4. `curl http://localhost:4111/health` returns JSON (API still works)
5. `curl http://localhost:4111/` returns HTML (dashboard served)
  </verify>
  <done>
Daemon serves dashboard SPA at localhost:4111. API routes work. SPA client-side routing works (unmatched paths serve index.html). CORS enabled for dev.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: End-to-end verification of CLI and Dashboard</name>
  <files>apps/daemon/src/http.ts</files>
  <action>
Human verifies the complete Phase 3 output: CLI commands and dashboard pages.

What was built: Complete CLI (5 commands: register, remove, list, status, grep) + Dashboard SPA (Overview, Traces waterfall, Repo explorer with file detail) + daemon serving dashboard at :4111. All dashboard components from @lens/ui shared package.
  </action>
  <verify>
1. Build everything: `pnpm -r build`
2. Start daemon: `LENS_MCP=false node apps/daemon/dist/index.js`
3. Test CLI commands:
   - `node packages/cli/dist/index.js status` -> shows daemon health
   - `node packages/cli/dist/index.js register /path/to/some/repo` -> registers repo
   - `node packages/cli/dist/index.js list` -> shows registered repos
   - `node packages/cli/dist/index.js grep "someQuery" --repo /path/to/some/repo` -> shows grep results
4. Open http://localhost:4111 in browser:
   - Overview page shows stat cards and repo grid
   - Click "Repos" in sidebar -> repo list with register form
   - Click a repo -> two-panel detail with files table
   - Click a file -> Sheet opens with structural context (exports, imports, co-changes)
   - Click "Traces" -> trace list table
   - Click a trace -> Sheet opens with waterfall bars showing span timing
5. Verify dark mode toggle works
6. Verify sidebar collapses to icon-only mode
  </verify>
  <done>
User confirms: CLI commands work end-to-end, dashboard pages render with v1-matching design, trace waterfall shows span timing, repo explorer shows file metadata with structural context.
  </done>
</task>

</tasks>

<verification>
- `pnpm -r build` — all packages build clean
- Daemon serves dashboard at :4111
- API routes still respond correctly
- CLI commands work end-to-end
- Dashboard pages render with v1-matching design
- Sidebar collapses to icon-only mode (v1 behavior from @lens/ui)
</verification>

<success_criteria>
Opening localhost:4111 shows the dashboard SPA. All CLI commands work. The trace waterfall displays span timing. The repo explorer shows file metadata with structural context. Everything served from a single daemon process on :4111.
</success_criteria>

<output>
After completion, create `.planning/phases/03-cli-dashboard/03-07-SUMMARY.md`
</output>
