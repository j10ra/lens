---
phase: 03-cli-dashboard
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/dashboard/package.json
  - apps/dashboard/index.html
  - apps/dashboard/vite.config.ts
  - apps/dashboard/tsconfig.json
  - apps/dashboard/components.json
  - apps/dashboard/src/main.tsx
  - apps/dashboard/src/globals.css
  - apps/dashboard/src/router.tsx
  - apps/dashboard/src/lib/api.ts
  - apps/dashboard/src/lib/utils.ts
  - apps/dashboard/src/store/repo-store.ts
  - apps/dashboard/src/store/trace-store.ts
  - apps/dashboard/src/queries/use-repos.ts
  - apps/dashboard/src/queries/use-traces.ts
  - apps/dashboard/src/components/ui/badge.tsx
  - apps/dashboard/src/components/ui/button.tsx
  - apps/dashboard/src/components/ui/card.tsx
  - apps/dashboard/src/components/ui/checkbox.tsx
  - apps/dashboard/src/components/ui/separator.tsx
  - apps/dashboard/src/components/ui/sheet.tsx
  - apps/dashboard/src/components/ui/sidebar.tsx
  - apps/dashboard/src/components/ui/switch.tsx
  - apps/dashboard/src/components/ui/table.tsx
  - apps/dashboard/src/components/ui/tabs.tsx
autonomous: true
requirements: [DASH-04, DASH-05]

must_haves:
  truths:
    - "pnpm --filter @lens/dashboard dev starts Vite dev server on port 5173"
    - "pnpm --filter @lens/dashboard build produces dist/ with index.html and assets"
    - "Dashboard uses shadcn/ui components (Badge, Button, Card, Sheet, Table, Sidebar primitives)"
    - "All daemon API calls go through TanStack Query hooks (useQuery, useMutation)"
    - "Client-side UI state uses TanStack Store (repoStore, traceStore) with selectors"
    - "shadcn components are ported from v1-archive (deterministic, no npx shadcn CLI)"
  artifacts:
    - path: "apps/dashboard/src/main.tsx"
      provides: "React entry point with QueryClientProvider and RouterProvider"
      min_lines: 15
    - path: "apps/dashboard/src/router.tsx"
      provides: "react-router v7 routes with placeholder pages"
    - path: "apps/dashboard/src/lib/api.ts"
      provides: "DAEMON_URL constant and typed fetch wrappers"
      exports: ["DAEMON_URL", "api"]
    - path: "apps/dashboard/src/store/repo-store.ts"
      provides: "TanStack Store for repo UI state"
      exports: ["repoStore", "useSelectedRepoId"]
    - path: "apps/dashboard/src/store/trace-store.ts"
      provides: "TanStack Store for trace UI state"
      exports: ["traceStore", "useSelectedTraceId"]
    - path: "apps/dashboard/src/components/ui/sidebar.tsx"
      provides: "shadcn sidebar primitives ported from v1-archive"
  key_links:
    - from: "apps/dashboard/src/main.tsx"
      to: "apps/dashboard/src/router.tsx"
      via: "RouterProvider"
      pattern: "RouterProvider.*router"
    - from: "apps/dashboard/src/queries/use-repos.ts"
      to: "apps/dashboard/src/lib/api.ts"
      via: "DAEMON_URL fetch"
      pattern: "DAEMON_URL"
---

<objective>
Scaffold the dashboard SPA infrastructure: deps, config, CSS theme, shadcn components (ported from v1-archive), TanStack Query/Store, router with placeholder routes, API client.

Purpose: Establish all build tooling, state management, and UI primitive infrastructure so subsequent plans can build pages on top without any setup work.
Output: Working Vite dev server that builds clean, with all shadcn components available, stores/hooks wired, router with placeholder pages.
</objective>

<execution_context>
@/Users/jalipalo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jalipalo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-cli-dashboard/03-RESEARCH.md
@apps/dashboard/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dashboard deps, config files, CSS theme</name>
  <files>
    apps/dashboard/package.json
    apps/dashboard/index.html
    apps/dashboard/vite.config.ts
    apps/dashboard/tsconfig.json
    apps/dashboard/components.json
    apps/dashboard/src/globals.css
    apps/dashboard/src/lib/utils.ts
  </files>
  <action>
**1. Install dependencies:**
```
pnpm --filter @lens/dashboard add react react-dom react-router @tanstack/react-query @tanstack/react-query-devtools @tanstack/react-store lucide-react clsx tailwind-merge class-variance-authority
pnpm --filter @lens/dashboard add -D vite @vitejs/plugin-react tailwindcss @tailwindcss/vite typescript @types/react @types/react-dom
```

**2. Config files:**

`vite.config.ts` — Tailwind v4 via `@tailwindcss/vite` plugin, `@vitejs/plugin-react`, path alias `@` -> `./src`. See research Pattern 3.

`tsconfig.json`:
```json
{
  "compilerOptions": {
    "target": "ES2022",
    "lib": ["ES2022", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "moduleResolution": "bundler",
    "jsx": "react-jsx",
    "strict": true,
    "skipLibCheck": true,
    "baseUrl": ".",
    "paths": { "@/*": ["./src/*"] },
    "noEmit": true
  },
  "include": ["src"]
}
```

`index.html` — standard Vite React SPA template: `<div id="root"></div>`, `<script type="module" src="/src/main.tsx"></script>`.

`components.json` — shadcn config for Vite:
```json
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": false,
  "tsx": true,
  "tailwind": { "config": "", "css": "src/globals.css", "baseColor": "neutral", "cssVariables": true },
  "aliases": { "components": "@/components", "utils": "@/lib/utils", "ui": "@/components/ui", "lib": "@/lib", "hooks": "@/hooks" }
}
```

**3. `src/globals.css`** — replicate v1 theme. Copy the EXACT v1 theme from `git show v1-archive:packages/ui/src/globals.css` which includes `--success`, `--warning` custom properties, dark-first OKLCH palette, `@theme inline` block with `--font-sans: "Inter Variable"`. Use `@import "tailwindcss"` (v4). Add `@import "@fontsource-variable/inter"` (install via pnpm). Do NOT create `tailwind.config.ts` — v4 uses plugin only.

**4. `src/lib/utils.ts`** — Copy from `git show v1-archive:packages/ui/src/lib/utils.ts`. This is the standard shadcn `cn()` utility (clsx + tailwind-merge). Also add `timeAgo(date)` and `formatDuration(ms)` helpers matching v1.
  </action>
  <verify>
1. `pnpm install` succeeds (new deps)
2. `pnpm --filter @lens/dashboard build` produces `dist/index.html` (will need main.tsx from Task 2 — verify after Task 2)
  </verify>
  <done>
Config files created. globals.css has v1 OKLCH theme. lib/utils.ts has cn() utility. All dependencies installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: shadcn components from v1-archive, stores, hooks, router, main entry</name>
  <files>
    apps/dashboard/src/components/ui/badge.tsx
    apps/dashboard/src/components/ui/button.tsx
    apps/dashboard/src/components/ui/card.tsx
    apps/dashboard/src/components/ui/checkbox.tsx
    apps/dashboard/src/components/ui/separator.tsx
    apps/dashboard/src/components/ui/sheet.tsx
    apps/dashboard/src/components/ui/sidebar.tsx
    apps/dashboard/src/components/ui/switch.tsx
    apps/dashboard/src/components/ui/table.tsx
    apps/dashboard/src/components/ui/tabs.tsx
    apps/dashboard/src/store/repo-store.ts
    apps/dashboard/src/store/trace-store.ts
    apps/dashboard/src/queries/use-repos.ts
    apps/dashboard/src/queries/use-traces.ts
    apps/dashboard/src/lib/api.ts
    apps/dashboard/src/router.tsx
    apps/dashboard/src/main.tsx
  </files>
  <action>
**1. Port shadcn components from v1-archive (NO `npx shadcn` — deterministic file copy):**

For EACH of these 10 files, read from v1-archive and write to `apps/dashboard/src/components/ui/`:
```
git show v1-archive:packages/ui/src/components/ui/badge.tsx
git show v1-archive:packages/ui/src/components/ui/button.tsx
git show v1-archive:packages/ui/src/components/ui/card.tsx
git show v1-archive:packages/ui/src/components/ui/checkbox.tsx
git show v1-archive:packages/ui/src/components/ui/separator.tsx
git show v1-archive:packages/ui/src/components/ui/sheet.tsx
git show v1-archive:packages/ui/src/components/ui/sidebar.tsx
git show v1-archive:packages/ui/src/components/ui/switch.tsx
git show v1-archive:packages/ui/src/components/ui/table.tsx
git show v1-archive:packages/ui/src/components/ui/tabs.tsx
```

After copying each file, update import paths:
- Replace `@lens/ui/lib/utils` with `@/lib/utils` (local project alias)
- Replace any `@lens/ui` imports with local `@/` equivalents
- Do NOT change component logic or styling

Also install peer deps required by shadcn components:
```
pnpm --filter @lens/dashboard add @radix-ui/react-dialog @radix-ui/react-separator @radix-ui/react-slot @radix-ui/react-switch @radix-ui/react-checkbox @radix-ui/react-tabs @radix-ui/react-tooltip @radix-ui/react-visually-hidden
```

**2. `src/lib/api.ts`** — export `DAEMON_URL = "http://localhost:4111"`. Export `api` object with typed fetch wrappers. v2 API paths:
- `api.health()` -> GET `/health`
- `api.repos()` -> GET `/repos` (returns array, not `{ repos: [...] }`)
- `api.stats()` -> GET `/stats`
- `api.traces(limit?)` -> GET `/traces?limit=N`
- `api.traceSpans(traceId)` -> GET `/traces/{traceId}`
- `api.repoFiles(id, params?)` -> GET `/repos/{id}/files?limit=N&offset=N&search=S`
- `api.repoFileDetail(repoId, filePath)` -> GET `/repos/{repoId}/files/{encodeURIComponent(filePath)}`
- `api.reindex(repoId)` -> POST `/repos/{repoId}/index`
- `api.registerRepo(rootPath, name?)` -> POST `/repos` with `{ path, name }`
- `api.removeRepo(id)` -> DELETE `/repos/{id}`

All fetch wrappers check `res.ok` and throw on non-2xx per research anti-patterns.

**3. TanStack Store:**

`src/store/repo-store.ts` — `createStore({ selectedRepoId: null, selectedFilePath: null })`. Export selector hooks `useSelectedRepoId()`, `useSelectedFilePath()` and mutators `selectRepo(id)`, `selectFile(path)`. Always use selector in `useStore()` — never bare `useStore(store)`.

`src/store/trace-store.ts` — `createStore({ selectedTraceId: null, filterText: "" })`. Export `useSelectedTraceId()`, `useTraceFilter()`, `selectTrace(id)`, `setTraceFilter(text)`.

**4. TanStack Query hooks:**

`src/queries/use-repos.ts` — `useRepos()` hook: `queryKey: ["repos"]`, calls `api.repos()`, `refetchInterval: 10_000`. Export `Repo` type.

`src/queries/use-traces.ts` — `useTraces(limit?)` hook: `queryKey: ["traces", limit]`, calls `api.traces(limit)`, `refetchInterval: 5_000`. `useTraceSpans(traceId)` hook: `queryKey: ["trace-spans", traceId]`, calls `api.traceSpans(traceId)`, `enabled: !!traceId`.

**5. Router (`src/router.tsx`):**
Use react-router v7 — import from `"react-router"` NOT `"react-router-dom"`. `createBrowserRouter` with routes:
- `/` -> placeholder "Overview" div (RootLayout not yet built — that's plan 03-03)
- `/repos` -> placeholder "Repos" div
- `/repos/:repoId` -> placeholder "RepoDetail" div
- `/traces` -> placeholder "Traces" div

NOTE: RootLayout wrapping will be added in 03-03. For now, just define the flat routes so the build passes.

**6. Main entry (`src/main.tsx`):**
```tsx
const queryClient = new QueryClient({
  defaultOptions: { queries: { staleTime: 5_000, refetchOnWindowFocus: true, retry: 2 } },
});
// QueryClient at module level (NOT inside component body — research Pitfall 7)
ReactDOM.createRoot(root).render(
  <StrictMode>
    <QueryClientProvider client={queryClient}>
      <RouterProvider router={router} />
      <ReactQueryDevtools initialIsOpen={false} />
    </QueryClientProvider>
  </StrictMode>
);
```
  </action>
  <verify>
1. `pnpm install` succeeds (radix deps)
2. `pnpm --filter @lens/dashboard build` produces `dist/index.html`
3. No `@lens/ui` imports remain in any dashboard file (grep confirms)
4. All 10 shadcn component files exist under `src/components/ui/`
  </verify>
  <done>
10 shadcn components ported from v1-archive with local import paths. API client, TanStack stores, query hooks, router, and main entry all wired. Dashboard builds clean.
  </done>
</task>

</tasks>

<verification>
- `pnpm --filter @lens/dashboard build` passes
- `apps/dashboard/dist/index.html` exists
- All 10 shadcn UI components exist in `src/components/ui/`
- No `@lens/ui` imports remain (all rewritten to `@/` local alias)
- TanStack Store instances created (repo-store, trace-store)
- TanStack Query hooks exist (use-repos, use-traces)
- Router defines 4 routes (/, /repos, /repos/:repoId, /traces)
</verification>

<success_criteria>
Dashboard SPA scaffold complete: builds with Vite, all shadcn primitives available from v1-archive, TanStack Query hooks and Store instances wired, API client typed, router with placeholder pages. Ready for layout and page components in 03-03.
</success_criteria>

<output>
After completion, create `.planning/phases/03-cli-dashboard/03-02-SUMMARY.md`
</output>
