---
phase: 03-cli-dashboard
plan: 06
type: execute
wave: 3
depends_on: ["03-04"]
files_modified:
  - apps/dashboard/src/pages/Repos.tsx
  - apps/dashboard/src/pages/RepoDetail.tsx
  - apps/dashboard/src/queries/use-repo-files.ts
  - apps/dashboard/src/router.tsx
autonomous: true
requirements: [DASH-03]

must_haves:
  truths:
    - "Repos page shows registered repos as cards with name, path, status badge, file/chunk counts"
    - "Repos page has a register form (inline in PageHeader) for adding new repos"
    - "Clicking a repo card navigates to /repos/:repoId"
    - "RepoDetail has two-panel layout: left sidebar (w-48) with section nav + right content area"
    - "RepoDetail Overview tab shows index stats, repo path"
    - "RepoDetail Files tab shows dense table with #/Path/Lang/Exports/Chunks columns"
    - "Clicking a file in the table opens a Sheet with structural context: exports, imports, imported_by, git stats, cochanges"
    - "File detail Sheet allows navigation between files (clicking import/imported_by links)"
    - "All UI primitives (Card, Badge, Sheet, PageHeader, Separator) imported from @lens/ui"
  artifacts:
    - path: "apps/dashboard/src/pages/Repos.tsx"
      provides: "Repos list page with register form"
      min_lines: 60
    - path: "apps/dashboard/src/pages/RepoDetail.tsx"
      provides: "Repo detail two-panel page with tabs"
      min_lines: 150
    - path: "apps/dashboard/src/queries/use-repo-files.ts"
      provides: "TanStack Query hooks for repo files and file detail"
      exports: ["useRepoFiles", "useRepoFileDetail"]
  key_links:
    - from: "apps/dashboard/src/pages/Repos.tsx"
      to: "@lens/ui"
      via: "import { Card, PageHeader, Badge }"
      pattern: "from.*@lens/ui"
    - from: "apps/dashboard/src/pages/RepoDetail.tsx"
      to: "@lens/ui"
      via: "import { Card, Sheet, SheetContent, PageHeader, Badge, Separator, Tabs }"
      pattern: "from.*@lens/ui"
    - from: "apps/dashboard/src/pages/RepoDetail.tsx"
      to: "apps/dashboard/src/queries/use-repo-files.ts"
      via: "useRepoFiles() hook"
      pattern: "useRepoFiles"
    - from: "apps/dashboard/src/pages/RepoDetail.tsx"
      to: "apps/dashboard/src/store/repo-store.ts"
      via: "selectFile/useSelectedFilePath"
      pattern: "selectFile|useSelectedFilePath"
---

<objective>
Build the repo explorer — repos list page and repo detail page with file explorer and structural context.

Purpose: Let users browse repos, see indexed files with metadata, and inspect structural context (imports, importers, co-changes, git stats) for any file.
Output: Repos page with cards + register form, RepoDetail page with two-panel layout and file detail Sheet.
</objective>

<execution_context>
@/Users/jalipalo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jalipalo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-cli-dashboard/03-RESEARCH.md
@.planning/phases/03-cli-dashboard/03-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Repos page with register form and repo cards</name>
  <files>
    apps/dashboard/src/pages/Repos.tsx
    apps/dashboard/src/queries/use-repo-files.ts
    apps/dashboard/src/router.tsx
  </files>
  <action>
**1. Create `src/queries/use-repo-files.ts`:**

```typescript
export function useRepoFiles(repoId: string, params: { limit?: number; offset?: number; search?: string }) {
  return useQuery({
    queryKey: ["repo-files", repoId, params.offset, params.search],
    queryFn: () => api.repoFiles(repoId, params),
    enabled: !!repoId,
    placeholderData: keepPreviousData,
  });
}

export function useRepoFileDetail(repoId: string, filePath: string | null) {
  return useQuery({
    queryKey: ["repo-file-detail", repoId, filePath],
    queryFn: () => api.repoFileDetail(repoId, filePath!),
    enabled: !!filePath,
  });
}
```

**2. Create `src/pages/Repos.tsx` — port v1 Repos page design:**

Import from @lens/ui:
```tsx
import { Card, CardContent, CardHeader, CardTitle, PageHeader, Badge } from "@lens/ui";
```
Import StatusBadge from local `@/components/StatusBadge`.

PageHeader (from @lens/ui) with toggle register form:
- Default: "Repositories" title + count + "Register" button (Plus icon)
- Register mode: inline form with FolderPlus icon input (`/absolute/path/to/repo`), Register button, Cancel button
- Use `useMutation` for register: POST to `/repos` via `api.registerRepo()`, invalidate `["repos"]` on success

Repo grid:
- `grid gap-3 p-3 @xl/main:grid-cols-2` (v1 uses same container query grid)
- Each repo as a card (Card from @lens/ui):
  - Header: repo name as Link to `/repos/{id}` (text-primary hover:underline), StatusBadge
  - Subtitle: root_path in `text-[10px] text-muted-foreground`
  - Stats grid: Files, Chunks, Last indexed (timeAgo)
  - Re-index button (RefreshCw icon) using `useMutation` calling `api.reindex()`
- Empty state: "No repos registered. Run: `lens register <path>`"

v2 simplification vs v1: Remove watcher/enrichment/Pro sections (v2 has no cloud features). Keep the core: name, path, status, stats, re-index action.

**3. Update `router.tsx`** — wire `/repos` route to Repos component (replace placeholder).
  </action>
  <verify>
`pnpm --filter @lens/dashboard build` succeeds. `grep "@lens/ui" apps/dashboard/src/pages/Repos.tsx` confirms shared imports. Router maps /repos.
  </verify>
  <done>
Repos page shows repo cards with register form, using Card/PageHeader from @lens/ui. Re-index works via mutation. Clicking repo navigates to detail.
  </done>
</task>

<task type="auto">
  <name>Task 2: RepoDetail page with two-panel layout, files table, file detail Sheet</name>
  <files>
    apps/dashboard/src/pages/RepoDetail.tsx
    apps/dashboard/src/router.tsx
  </files>
  <action>
Create `src/pages/RepoDetail.tsx` — port v1 RepoDetail design, adapted for v2.

Import from @lens/ui:
```tsx
import {
  Card, CardContent, CardHeader, CardTitle,
  Sheet, SheetContent, SheetHeader, SheetTitle, SheetDescription,
  PageHeader, Badge, Separator
} from "@lens/ui";
```
Import StatusBadge from local `@/components/StatusBadge`.

**Page structure (EXACT v1 two-panel layout):**

1. **PageHeader** (from @lens/ui): Back button (ArrowLeft) -> "/repos", repo name, action buttons (Re-index, Remove with confirm)

2. **Two-panel body** (`flex flex-1 min-h-0`):
   - Left sidebar: `hidden w-48 shrink-0 flex-col border-r border-border bg-muted/30 md:flex`
   - Section nav buttons: Overview (LayoutDashboard), Files (Files icon)
   - Each button: `flex w-full items-center gap-2 px-3 py-2 text-xs`, active state uses `bg-accent text-accent-foreground`
   - Files button shows count badge: `ml-auto font-mono text-[10px] tabular-nums opacity-60`
   - Mobile: `<select>` dropdown for section switching (md:hidden)
   - Right content: `flex min-w-0 min-h-0 flex-1 flex-col`

3. **Overview tab:**
   - Grid cards (Card from @lens/ui, `gap-2 @xl/main:grid-cols-2 @3xl/main:grid-cols-3`):
     - Index card: status badge, files count, chunks count, last indexed time, last commit
     - Repository card: full root_path in mono
   - v2 simplification: Remove enrichment/watcher/Pro cards from v1

4. **Files tab (EXACT v1 design):**
   - Toolbar: search input (Search icon, w-52, border, text-xs), file count
   - Dense raw `<table>` (NOT DataTable component):
     - Sticky thead `bg-muted/60`
     - Columns: # (row number, w-12, centered), Path (clickable, font-mono text-primary hover:underline), Lang (w-16), Exports (w-16, right-aligned, count), Chunks (w-16, right-aligned)
     - Cell styling: `border-b border-r border-border px-3 py-1.5`
     - Row number column: `bg-muted/20 font-mono text-[10px] tabular-nums`
     - Hover: `hover:bg-accent/30`
   - Clicking Path opens file detail Sheet (set selectedFilePath)
   - Pagination footer when total > 100: page range, Prev/Next buttons
   - Use `useRepoFiles()` hook with `enabled: activeTab === "files"`

5. **File detail Sheet (EXACT v1 design):**
   - `<SheetContent side="right" className="overflow-y-auto sm:max-w-xl">`
   - SheetTitle: file path (font-mono, break-all, select-all)
   - SheetDescription: language, chunk count
   - Sections separated by `<Separator />` (from @lens/ui):
     - Exports: flex-wrap Badge list (Badge from @lens/ui, variant="secondary", font-mono text-[10px])
     - Sections: flex-wrap Badge list (variant="outline")
     - Internals: flex-wrap Badge list (variant="secondary", bg-muted/50)
     - Imports (ArrowUpRight icon): clickable paths (text-primary hover:underline) -> `setSelectedFilePath(path)` for navigation
     - Imported by (ArrowDownLeft icon): clickable paths -> navigate
     - Git activity (GitCommit icon): grid-cols-3 with commits, recent (90d), last modified
     - Co-changes (Hash icon): list of `path Nx` with clickable paths -> navigate
   - Use `useRepoFileDetail(repoId, selectedFilePath)` hook
   - File navigation: clicking import/imported_by/cochange path sets `selectedFilePath` to that path (Sheet content updates reactively)

6. **State management:**
   - `activeTab` via local `useState("overview")`
   - `selectedFilePath` via local `useState<string | null>(null)` (Sheet-local, no global store needed for this)
   - `filePage`, `fileSearch` via local useState
   - Repo data: reuse `useRepos()` + find by repoId
   - Use `useParams()` from react-router for `repoId`
   - Remove mutation and its confirmation: `useMutation` for remove -> DELETE `/repos/{id}`, navigate to `/repos` on success

**v2 simplifications vs v1:**
- Remove: chunks tab, vocab tab, watcher controls, enrichment toggles, Pro badges
- Keep: overview, files tab, file detail sheet with full structural context
- SECTIONS array: just `["overview", "files"]` (v1 had overview/files/chunks/vocab)

**7. Update `router.tsx`** — wire `/repos/:repoId` route to RepoDetail (replace placeholder).
  </action>
  <verify>
1. `pnpm --filter @lens/dashboard build` succeeds
2. `grep "@lens/ui" apps/dashboard/src/pages/RepoDetail.tsx` confirms shared imports
3. RepoDetail.tsx has two-panel layout (grep for `w-48.*border-r`)
4. File detail Sheet has structural context sections (grep for `Imported by|Imports|Co-changes|Git activity`)
5. Router maps /repos/:repoId to RepoDetail
  </verify>
  <done>
RepoDetail page has two-panel layout with overview and files tabs. All UI primitives from @lens/ui. Files table shows dense raw table with file metadata. File detail Sheet shows full structural context with inter-file navigation. v1 design preserved.
  </done>
</task>

</tasks>

<verification>
- `pnpm --filter @lens/dashboard build` passes
- Repos page imports Card/PageHeader from @lens/ui
- RepoDetail imports Card/Sheet/Badge/Separator from @lens/ui
- No imports from apps/dashboard/src/components/ui/ (all from @lens/ui)
- RepoDetail has two-panel layout with files table
- File detail Sheet shows structural context
- All routes wired in router.tsx
</verification>

<success_criteria>
Repo explorer complete: repos list with register/re-index, repo detail with two-panel file browser, file detail Sheet with imports/importers/git/co-changes. All UI primitives from @lens/ui. Dense table styling matches v1 exactly. Inter-file navigation works in Sheet.
</success_criteria>

<output>
After completion, create `.planning/phases/03-cli-dashboard/03-06-SUMMARY.md`
</output>
