---
phase: 03-cli-dashboard
plan: 03
type: execute
wave: 2
depends_on: ["03-02"]
files_modified:
  - apps/dashboard/package.json
  - apps/dashboard/index.html
  - apps/dashboard/vite.config.ts
  - apps/dashboard/tsconfig.json
  - apps/dashboard/src/main.tsx
  - apps/dashboard/src/router.tsx
  - apps/dashboard/src/lib/api.ts
  - apps/dashboard/src/store/repo-store.ts
  - apps/dashboard/src/store/trace-store.ts
  - apps/dashboard/src/queries/use-repos.ts
  - apps/dashboard/src/queries/use-traces.ts
autonomous: true
requirements: [DASH-04]

must_haves:
  truths:
    - "pnpm --filter @lens/dashboard dev starts Vite dev server on port 5173"
    - "pnpm --filter @lens/dashboard build produces dist/ with index.html and assets"
    - "Dashboard imports components from @lens/ui (NOT local src/components/ui/)"
    - "Dashboard imports globals.css from @lens/ui/globals.css"
    - "All daemon API calls go through TanStack Query hooks (useQuery, useMutation)"
    - "Client-side UI state uses TanStack Store (repoStore, traceStore) with selectors"
  artifacts:
    - path: "apps/dashboard/src/main.tsx"
      provides: "React entry point with QueryClientProvider and RouterProvider"
      min_lines: 15
    - path: "apps/dashboard/src/router.tsx"
      provides: "react-router v7 routes with placeholder pages"
    - path: "apps/dashboard/src/lib/api.ts"
      provides: "DAEMON_URL constant and typed fetch wrappers"
      exports: ["DAEMON_URL", "api"]
    - path: "apps/dashboard/src/store/repo-store.ts"
      provides: "TanStack Store for repo UI state"
      exports: ["repoStore", "useSelectedRepoId"]
    - path: "apps/dashboard/src/store/trace-store.ts"
      provides: "TanStack Store for trace UI state"
      exports: ["traceStore", "useSelectedTraceId"]
  key_links:
    - from: "apps/dashboard/src/main.tsx"
      to: "apps/dashboard/src/router.tsx"
      via: "RouterProvider"
      pattern: "RouterProvider.*router"
    - from: "apps/dashboard/src/main.tsx"
      to: "@lens/ui/globals.css"
      via: "CSS import"
      pattern: "@lens/ui/globals.css"
    - from: "apps/dashboard/src/queries/use-repos.ts"
      to: "apps/dashboard/src/lib/api.ts"
      via: "DAEMON_URL fetch"
      pattern: "DAEMON_URL"
---

<objective>
Scaffold the dashboard SPA infrastructure: deps, Vite config, TanStack Query/Store, router, API client. Components come from @lens/ui (plan 03-02).

Purpose: Establish build tooling, state management, and data fetching so subsequent plans can build pages importing from @lens/ui without any setup work.
Output: Working Vite dev server that builds clean, with stores/hooks wired, router with placeholder pages, importing theme from @lens/ui.
</objective>

<execution_context>
@/Users/jalipalo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jalipalo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-cli-dashboard/03-RESEARCH.md
@.planning/phases/03-cli-dashboard/03-02-SUMMARY.md
@apps/dashboard/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dashboard deps, config files, Vite + Tailwind setup</name>
  <files>
    apps/dashboard/package.json
    apps/dashboard/index.html
    apps/dashboard/vite.config.ts
    apps/dashboard/tsconfig.json
  </files>
  <action>
**1. Install dependencies:**
```
pnpm --filter @lens/dashboard add react react-dom react-router @tanstack/react-query @tanstack/react-query-devtools @tanstack/react-store @lens/ui
pnpm --filter @lens/dashboard add -D vite @vitejs/plugin-react tailwindcss @tailwindcss/vite typescript @types/react @types/react-dom
```

Note: `@lens/ui` resolves as workspace dependency. It brings its own peer deps (radix, lucide-react, cva, clsx, tailwind-merge, fontsource-inter, tw-animate-css) — dashboard does NOT need to install these separately since they're @lens/ui's direct dependencies.

**2. vite.config.ts** — Tailwind v4 via `@tailwindcss/vite` plugin, `@vitejs/plugin-react`, path alias `@` -> `./src`. See research Pattern 3.

**3. tsconfig.json:**
```json
{
  "compilerOptions": {
    "target": "ES2022",
    "lib": ["ES2022", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "moduleResolution": "bundler",
    "jsx": "react-jsx",
    "strict": true,
    "skipLibCheck": true,
    "baseUrl": ".",
    "paths": { "@/*": ["./src/*"] },
    "noEmit": true
  },
  "include": ["src"]
}
```

**4. index.html** — standard Vite React SPA: `<div id="root"></div>`, `<script type="module" src="/src/main.tsx"></script>`.
  </action>
  <verify>
1. `pnpm install` succeeds (new deps)
2. `ls apps/dashboard/vite.config.ts` exists
3. `grep "@lens/ui" apps/dashboard/package.json` confirms workspace dependency
  </verify>
  <done>
Config files created. All dependencies installed including @lens/ui workspace dep. Vite configured with Tailwind v4 plugin.
  </done>
</task>

<task type="auto">
  <name>Task 2: API client, stores, query hooks, router, main entry</name>
  <files>
    apps/dashboard/src/main.tsx
    apps/dashboard/src/router.tsx
    apps/dashboard/src/lib/api.ts
    apps/dashboard/src/store/repo-store.ts
    apps/dashboard/src/store/trace-store.ts
    apps/dashboard/src/queries/use-repos.ts
    apps/dashboard/src/queries/use-traces.ts
  </files>
  <action>
**1. `src/lib/api.ts`** — export `DAEMON_URL = "http://localhost:4111"`. Export `api` object with typed fetch wrappers. v2 API paths:
- `api.health()` -> GET `/health`
- `api.repos()` -> GET `/repos` (returns array, not `{ repos: [...] }`)
- `api.stats()` -> GET `/stats`
- `api.traces(limit?)` -> GET `/traces?limit=N`
- `api.traceSpans(traceId)` -> GET `/traces/{traceId}`
- `api.repoFiles(id, params?)` -> GET `/repos/{id}/files?limit=N&offset=N&search=S`
- `api.repoFileDetail(repoId, filePath)` -> GET `/repos/{repoId}/files/{encodeURIComponent(filePath)}`
- `api.reindex(repoId)` -> POST `/repos/{repoId}/index`
- `api.registerRepo(rootPath, name?)` -> POST `/repos` with `{ path, name }`
- `api.removeRepo(id)` -> DELETE `/repos/{id}`

All fetch wrappers check `res.ok` and throw on non-2xx per research anti-patterns.

**2. TanStack Store:**

`src/store/repo-store.ts` — `createStore({ selectedRepoId: null, selectedFilePath: null })`. Export selector hooks `useSelectedRepoId()`, `useSelectedFilePath()` and mutators `selectRepo(id)`, `selectFile(path)`. Always use selector in `useStore()` — never bare `useStore(store)`.

`src/store/trace-store.ts` — `createStore({ selectedTraceId: null, filterText: "" })`. Export `useSelectedTraceId()`, `useTraceFilter()`, `selectTrace(id)`, `setTraceFilter(text)`.

**3. TanStack Query hooks:**

`src/queries/use-repos.ts` — `useRepos()` hook: `queryKey: ["repos"]`, calls `api.repos()`, `refetchInterval: 10_000`. Export `Repo` type.

`src/queries/use-traces.ts` — `useTraces(limit?)` hook: `queryKey: ["traces", limit]`, calls `api.traces(limit)`, `refetchInterval: 5_000`. `useTraceSpans(traceId)` hook: `queryKey: ["trace-spans", traceId]`, calls `api.traceSpans(traceId)`, `enabled: !!traceId`.

**4. Router (`src/router.tsx`):**
Use react-router v7 — import from `"react-router"` NOT `"react-router-dom"`. `createBrowserRouter` with routes:
- `/` -> placeholder "Overview" div (RootLayout not yet built — that's plan 03-04)
- `/repos` -> placeholder "Repos" div
- `/repos/:repoId` -> placeholder "RepoDetail" div
- `/traces` -> placeholder "Traces" div

NOTE: RootLayout wrapping will be added in 03-04. For now, just define flat routes so the build passes.

**5. Main entry (`src/main.tsx`):**
```tsx
import "@lens/ui/globals.css";  // Theme from shared UI package

const queryClient = new QueryClient({
  defaultOptions: { queries: { staleTime: 5_000, refetchOnWindowFocus: true, retry: 2 } },
});
// QueryClient at module level (NOT inside component body — research Pitfall 7)
ReactDOM.createRoot(root).render(
  <StrictMode>
    <QueryClientProvider client={queryClient}>
      <RouterProvider router={router} />
      <ReactQueryDevtools initialIsOpen={false} />
    </QueryClientProvider>
  </StrictMode>
);
```

CRITICAL: Import `@lens/ui/globals.css` in main.tsx — this pulls the OKLCH theme from the shared package. Do NOT create a local globals.css in dashboard.
  </action>
  <verify>
1. `pnpm --filter @lens/dashboard build` produces `dist/index.html`
2. `grep "@lens/ui/globals.css" apps/dashboard/src/main.tsx` confirms shared CSS import
3. No local `apps/dashboard/src/globals.css` exists (theme comes from @lens/ui)
4. No `apps/dashboard/src/components/ui/` directory exists (components come from @lens/ui)
  </verify>
  <done>
API client, TanStack stores, query hooks, router, and main entry all wired. Dashboard imports theme from @lens/ui/globals.css. No local shadcn components — all from @lens/ui. Build passes.
  </done>
</task>

</tasks>

<verification>
- `pnpm --filter @lens/dashboard build` passes
- `apps/dashboard/dist/index.html` exists
- No `apps/dashboard/src/components/ui/` directory (all from @lens/ui)
- No `apps/dashboard/src/globals.css` (theme from @lens/ui/globals.css)
- `grep "@lens/ui" apps/dashboard/src/main.tsx` confirms import
- TanStack Store instances created (repo-store, trace-store)
- TanStack Query hooks exist (use-repos, use-traces)
- Router defines 4 routes (/, /repos, /repos/:repoId, /traces)
</verification>

<success_criteria>
Dashboard SPA scaffold complete: builds with Vite, imports theme and components from @lens/ui, TanStack Query hooks and Store instances wired, API client typed, router with placeholder pages. No local shadcn copies. Ready for layout and page components in 03-04.
</success_criteria>

<output>
After completion, create `.planning/phases/03-cli-dashboard/03-03-SUMMARY.md`
</output>
