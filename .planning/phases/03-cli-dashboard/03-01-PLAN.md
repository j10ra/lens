---
phase: 03-cli-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/cli/src/index.ts
  - packages/cli/src/commands/register.ts
  - packages/cli/src/commands/remove.ts
  - packages/cli/src/commands/list.ts
  - packages/cli/src/commands/grep.ts
  - packages/cli/src/commands/status.ts
  - packages/cli/src/lib/daemon.ts
  - packages/cli/src/lib/format.ts
autonomous: true
requirements: [CLI-02, CLI-03]

must_haves:
  truths:
    - "lens register <path> registers a repo via daemon HTTP and prints confirmation"
    - "lens remove <id> removes a repo via daemon HTTP and prints confirmation"
    - "lens list shows all repos with name, path, status in aligned columns"
    - "lens grep <query> shows ranked results per term with scores, hub flags, importers"
    - "lens status shows daemon health, uptime, version"
    - "All commands print helpful error when daemon is not running"
  artifacts:
    - path: "packages/cli/src/commands/register.ts"
      provides: "register subcommand"
      exports: ["register"]
    - path: "packages/cli/src/commands/remove.ts"
      provides: "remove subcommand"
      exports: ["remove"]
    - path: "packages/cli/src/commands/list.ts"
      provides: "list subcommand"
      exports: ["list"]
    - path: "packages/cli/src/commands/grep.ts"
      provides: "grep subcommand"
      exports: ["grep"]
    - path: "packages/cli/src/commands/status.ts"
      provides: "status subcommand (extracted)"
      exports: ["status"]
    - path: "packages/cli/src/lib/daemon.ts"
      provides: "shared daemon fetch helper"
      exports: ["DAEMON_URL", "daemonFetch"]
    - path: "packages/cli/src/lib/format.ts"
      provides: "terminal formatting utilities"
      exports: ["printTable"]
    - path: "packages/cli/src/index.ts"
      provides: "main CLI entry with all subcommands"
  key_links:
    - from: "packages/cli/src/commands/register.ts"
      to: "http://localhost:4111/repos"
      via: "POST fetch"
      pattern: "fetch.*repos.*POST"
    - from: "packages/cli/src/commands/grep.ts"
      to: "http://localhost:4111/grep"
      via: "POST fetch"
      pattern: "fetch.*grep.*POST"
    - from: "packages/cli/src/index.ts"
      to: "packages/cli/src/commands/*.ts"
      via: "citty subCommands"
      pattern: "subCommands.*register.*remove.*list.*grep.*status"
---

<objective>
Implement all CLI subcommands (register, remove, list, status, grep) with formatted terminal output.

Purpose: Give users terminal access to all daemon operations with human-readable output.
Output: 5 CLI subcommands callable via `lens <cmd>`, formatted output with aligned columns and status indicators.
</objective>

<execution_context>
@/Users/jalipalo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jalipalo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-cli-dashboard/03-RESEARCH.md
@packages/cli/src/index.ts
@apps/daemon/src/routes/repos.ts
@apps/daemon/src/routes/grep.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Shared CLI utilities and extracted status command</name>
  <files>
    packages/cli/src/lib/daemon.ts
    packages/cli/src/lib/format.ts
    packages/cli/src/commands/status.ts
  </files>
  <action>
Create shared daemon fetch helper (`lib/daemon.ts`):
- Export `DAEMON_URL = "http://localhost:4111"` constant
- Export `daemonFetch(path, init?)` wrapper that calls `fetch(DAEMON_URL + path, init)`, catches connection errors, and prints "lens daemon is not running. Start it with: lens daemon start" then `process.exit(1)` on network failure. On non-2xx, parses JSON error body and throws with message.

Create format utilities (`lib/format.ts`):
- Export `printTable(headers: string[], rows: string[][])` that calculates max column widths, prints header row, prints separator dashes, prints each data row with aligned padding. Use `pad(str, width)` helper that pads/truncates to width.

Extract the existing `status` command from `index.ts` into `commands/status.ts`:
- Export `status` as a `defineCommand` result
- Use `daemonFetch("/health")` instead of raw fetch
- Keep the same output format: version, status, uptime, url

console.log is correct in CLI (terminal binary, not daemon).
  </action>
  <verify>
Run `pnpm --filter @lens/cli build` — should compile without errors. Check that `dist/` output includes the new files.
  </verify>
  <done>
daemon.ts exports DAEMON_URL and daemonFetch. format.ts exports printTable. status.ts exports status command using shared helpers.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register, remove, list, grep commands and main entry</name>
  <files>
    packages/cli/src/commands/register.ts
    packages/cli/src/commands/remove.ts
    packages/cli/src/commands/list.ts
    packages/cli/src/commands/grep.ts
    packages/cli/src/index.ts
  </files>
  <action>
Create `commands/register.ts`:
- `defineCommand` with args: `path` (positional, required — absolute path to repo root), `name` (string, alias "n", optional — human-readable name)
- POST to `/repos` with `{ path: args.path, name: args.name }`
- Print: `Registered: {name} ({id})\n  path   : {root_path}\n  status : {index_status}`

Create `commands/remove.ts`:
- `defineCommand` with args: `id` (positional, required — repo UUID)
- DELETE to `/repos/{id}`
- Print: `Removed repo {id}`
- On 404: `Repo not found: {id}`

Create `commands/list.ts`:
- `defineCommand`, no args
- GET `/repos`, parse response as array
- If empty: `No repos registered. Use: lens register <path>`
- Otherwise print each repo with status icon (ready=checkmark, indexing=dots, pending=circle, error=x):
  ```
  {icon} {name}
    id     : {id}
    path   : {root_path}
    status : {index_status}
    indexed: {last_indexed_at or "never"}
  ```

Create `commands/grep.ts`:
- `defineCommand` with args: `query` (positional, required — pipe-separated terms), `repo` (string, alias "r" — repo root path, defaults to `process.cwd()`), `limit` (string, alias "l" — max results per term, default "20")
- POST to `/grep` with `{ repoPath, query: args.query, limit: parseInt(limit) }`
- Print per-term results:
  ```
  \n-- {term} ({count} results) --
    {path}{hubFlag}  score={score.toFixed(2)}{importedBy}
  ```
  where hubFlag is " [hub]" if isHub, importedBy shows first 2 importers preceded by " <- "
- On 404 from daemon: `Repo not registered. Run: lens register {repoPath}`

Update `index.ts`:
- Import all 5 commands from `./commands/*.js`
- Wire into `subCommands: { status, register, remove, list, grep }`
- Remove the inline `status` definition and `DAEMON_URL` constant (now in lib/daemon.ts)

All commands use `daemonFetch` from `lib/daemon.ts` for unified error handling.
  </action>
  <verify>
Run `pnpm --filter @lens/cli build` — compiles without errors. Run `pnpm --filter @lens/cli typecheck` — no type errors.
  </verify>
  <done>
All 5 subcommands (register, remove, list, status, grep) exported and wired in index.ts. Each command calls daemon HTTP with formatted terminal output. Build succeeds.
  </done>
</task>

</tasks>

<verification>
- `pnpm --filter @lens/cli build` passes
- `pnpm --filter @lens/cli typecheck` passes (if tsconfig exists)
- `packages/cli/dist/index.js` exists and includes all command imports
- grep `subCommands` in index.ts shows all 5: status, register, remove, list, grep
</verification>

<success_criteria>
All 5 CLI commands implemented with formatted output. Each calls daemon HTTP endpoints via shared daemonFetch helper. Build compiles clean.
</success_criteria>

<output>
After completion, create `.planning/phases/03-cli-dashboard/03-01-SUMMARY.md`
</output>
