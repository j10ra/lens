---
phase: 03-cli-dashboard
plan: 04
type: execute
wave: 2
depends_on: ["03-02", "03-03"]
files_modified:
  - apps/dashboard/src/components/RootLayout.tsx
  - apps/dashboard/src/components/StatusBadge.tsx
  - apps/dashboard/src/pages/Overview.tsx
  - apps/dashboard/src/router.tsx
  - packages/core/src/trace-store.ts
  - packages/core/src/index.ts
  - apps/daemon/src/routes/traces.ts
  - apps/daemon/src/routes/files.ts
  - apps/daemon/src/http.ts
autonomous: true
requirements: [DASH-01, DASH-06]

must_haves:
  truths:
    - "Dashboard layout matches v1: SidebarProvider > AppSidebar + SidebarInset with floating card"
    - "All shared components (AppSidebar, Logo, PageHeader, ModeToggle) imported from @lens/ui"
    - "Overview page shows stat cards and repo grid matching v1 design"
    - "GET /traces endpoint returns recent traces from TraceStore"
    - "GET /traces/:traceId endpoint returns spans for a specific trace"
    - "GET /repos/:id/files endpoint returns file metadata with structural context"
    - "GET /stats endpoint returns repos_count, total_files, total_chunks, uptime_seconds"
  artifacts:
    - path: "apps/dashboard/src/components/RootLayout.tsx"
      provides: "Root layout with sidebar, imports AppSidebar from @lens/ui"
    - path: "apps/dashboard/src/components/StatusBadge.tsx"
      provides: "Dashboard-specific StatusBadge component"
    - path: "apps/dashboard/src/pages/Overview.tsx"
      provides: "Overview page with stat cards and repo grid"
      min_lines: 60
    - path: "packages/core/src/trace-store.ts"
      provides: "queryTraces and querySpans methods"
    - path: "apps/daemon/src/routes/traces.ts"
      provides: "GET /traces and GET /traces/:traceId"
    - path: "apps/daemon/src/routes/files.ts"
      provides: "GET /repos/:id/files and GET /repos/:id/files/:path"
  key_links:
    - from: "apps/dashboard/src/components/RootLayout.tsx"
      to: "@lens/ui"
      via: "import { AppSidebar, SidebarProvider, SidebarInset }"
      pattern: "from.*@lens/ui"
    - from: "apps/dashboard/src/pages/Overview.tsx"
      to: "@lens/ui"
      via: "import { Card, PageHeader, Badge }"
      pattern: "from.*@lens/ui"
    - from: "apps/daemon/src/routes/traces.ts"
      to: "packages/core/src/trace-store.ts"
      via: "getTraceStore()"
      pattern: "getTraceStore"
    - from: "apps/daemon/src/http.ts"
      to: "apps/daemon/src/routes/traces.ts"
      via: "app.route"
      pattern: "app\\.route.*traces"
---

<objective>
Build RootLayout (using AppSidebar from @lens/ui), Overview page, and all daemon API routes the dashboard needs (traces, files, stats).

Purpose: With @lens/ui (03-02) and dashboard infrastructure (03-03) in place, this plan adds the v1-matching layout shell, the first real page (Overview), and all backend routes. After this, Plans 05/06 can build page components on a fully functional scaffold.
Output: Working dashboard with sidebar layout and Overview page; daemon has /traces, /repos/:id/files, and /stats routes.
</objective>

<execution_context>
@/Users/jalipalo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jalipalo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-cli-dashboard/03-RESEARCH.md
@.planning/phases/03-cli-dashboard/03-02-SUMMARY.md
@.planning/phases/03-cli-dashboard/03-03-SUMMARY.md
@apps/daemon/src/http.ts
@apps/daemon/src/index.ts
@packages/core/src/trace-store.ts
@packages/core/src/index.ts
@packages/engine/src/index.ts
@packages/engine/src/db/queries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: RootLayout, StatusBadge, Overview page, router update</name>
  <files>
    apps/dashboard/src/components/RootLayout.tsx
    apps/dashboard/src/components/StatusBadge.tsx
    apps/dashboard/src/pages/Overview.tsx
    apps/dashboard/src/router.tsx
  </files>
  <action>
**1. Dashboard-specific components:**

`src/components/StatusBadge.tsx` — Port v1 StatusBadge from dashboard (`git show v1-archive:apps/dashboard/src/components/StatusBadge.tsx`): Badge with color variants for ready/indexing/pending/error/active/inactive. Import `Badge` and `cn` from `@lens/ui` (NOT local paths).

`src/components/RootLayout.tsx` — Port v1 RootLayout design. Import ALL shared components from `@lens/ui`:
```tsx
import {
  AppSidebar, SidebarProvider, SidebarInset,
  type NavItem
} from "@lens/ui";
```

Layout structure (EXACT v1):
```tsx
<SidebarProvider className="bg-muted h-svh">
  <AppSidebar navItems={NAV_ITEMS} currentPath={location.pathname} renderLink={...} healthy={isHealthy} />
  <SidebarInset className="bg-background rounded-xl overflow-hidden md:my-2 md:mr-2 md:border">
    <div className="@container/main flex min-h-0 flex-1 flex-col">
      <Outlet />
    </div>
  </SidebarInset>
</SidebarProvider>
```

Use `useLocation()` from react-router for currentPath. Use `Link` from react-router in renderLink prop. Use `useQuery` for health check to set `isHealthy`. NAV_ITEMS: Overview (LayoutDashboard, "/"), Repos (FolderGit2, "/repos"), Traces (Activity, "/traces").

**2. Overview page (`src/pages/Overview.tsx`):**
Port v1 Overview page, adapted for v2 data. Import `Card, CardContent, CardHeader, CardTitle, PageHeader` from `@lens/ui`:
- Stat cards in `@container/main` responsive grid (`@xl/main:grid-cols-2 @3xl/main:grid-cols-4`)
- Cards: Repos (count), Files (total indexed), Chunks (total), Uptime
- Remove v1 cloud-only cards (Embeddings, Summaries, Vocab, DB Size) and Pro upsell
- Repo grid below stats: card per repo with name, path, StatusBadge, file/chunk counts, last indexed time
- Click repo card navigates to `/repos/{id}`
- Use `useRepos()` hook for data, `useQuery` for stats/health
- EXACT v1 styling: `Card` with `border-border bg-background py-4 shadow-none`, stat labels uppercase tracking-wide, icon in `rounded-md border p-1.5`
- PageHeader with "Overview" text

**3. Update `router.tsx`:**
- Wrap routes in RootLayout as parent route
- Set Overview as index route for `/`
- Keep placeholder divs for `/repos`, `/repos/:repoId`, `/traces` (replaced in later plans)
  </action>
  <verify>
1. `pnpm --filter @lens/dashboard build` produces `dist/index.html`
2. `grep "@lens/ui" apps/dashboard/src/components/RootLayout.tsx` confirms shared import
3. `grep "@lens/ui" apps/dashboard/src/pages/Overview.tsx` confirms shared import
4. No `apps/dashboard/src/components/ui/` directory exists
5. Router wraps routes in RootLayout parent
  </verify>
  <done>
RootLayout imports AppSidebar from @lens/ui. Overview page imports Card/PageHeader from @lens/ui. StatusBadge uses Badge from @lens/ui. Router updated with layout wrapper.
  </done>
</task>

<task type="auto">
  <name>Task 2: TraceStore query methods, getTraceStore singleton, daemon trace + file + stats routes</name>
  <files>
    packages/core/src/trace-store.ts
    packages/core/src/index.ts
    apps/daemon/src/routes/traces.ts
    apps/daemon/src/routes/files.ts
    apps/daemon/src/http.ts
  </files>
  <action>
**1. Add query methods to TraceStore (`packages/core/src/trace-store.ts`):**

Add `queryTraces(limit = 50)` method:
```typescript
queryTraces(limit = 50) {
  return this.sqlite
    .prepare("SELECT * FROM traces ORDER BY started_at DESC LIMIT ?")
    .all(limit) as Array<{
      trace_id: string; root_span_name: string;
      started_at: number; ended_at: number; duration_ms: number;
    }>;
}
```

Add `querySpans(traceId: string)` method:
```typescript
querySpans(traceId: string) {
  return this.sqlite
    .prepare("SELECT * FROM spans WHERE trace_id = ? ORDER BY started_at ASC")
    .all(traceId) as SpanRecord[];
}
```

**2. Add `getTraceStore` singleton to `trace-store.ts`:**

Add module-level `_instance` variable. Modify `createTraceStore()` to set `_instance`. Add `getTraceStore()` that returns `_instance` or throws if not initialized. This follows the existing `getEngineDb()`/`configureEngineDb()` singleton pattern from engine package.

**3. Export from `packages/core/src/index.ts`:**
Add `getTraceStore` to the export list.

**4. Rebuild core:**
`pnpm --filter @lens/core build`

**5. Create `apps/daemon/src/routes/traces.ts`:**
```typescript
import { getTraceStore, lensRoute } from "@lens/core";
import { Hono } from "hono";

export const tracesRoutes = new Hono();

// GET /traces — list recent traces
tracesRoutes.get("/", lensRoute("traces.list", async (c) => {
  const limit = Number(c.req.query("limit") ?? "50");
  const traces = getTraceStore().queryTraces(limit);
  return c.json(traces);
}));

// GET /traces/:traceId — spans for one trace
tracesRoutes.get("/:traceId", lensRoute("traces.get", async (c) => {
  const { traceId } = c.req.param();
  const spans = getTraceStore().querySpans(traceId);
  if (!spans.length) return c.json({ error: "trace not found" }, 404);
  return c.json({ traceId, spans });
}));
```

**6. Create `apps/daemon/src/routes/files.ts`:**
```typescript
import { lensRoute } from "@lens/core";
import { getEngineDb } from "@lens/engine";
import { Hono } from "hono";
```
- `GET /repos/:repoId/files` — query `file_metadata` for given repo. Support `?limit=100&offset=0&search=term`. Return `{ files: [...], total }`. Each file has: path, language, exports (JSON parsed), chunk_count (subquery on chunks table), import_count (count of file_imports where target_path matches). Use raw SQL via `getEngineDb().all(...)` for the join query.
- `GET /repos/:repoId/files/:filePath` — query single file metadata + imports (file_imports where source_path=filePath) + imported_by (file_imports where target_path=filePath) + git stats (file_stats) + cochanges (file_cochanges both directions). Return full structural context for file detail sheet.

**7. Wire routes in `apps/daemon/src/http.ts`:**
Import `tracesRoutes` and `filesRoutes`. Mount BEFORE any future serveStatic (API routes first — research Pitfall 1):
```typescript
app.route("/traces", tracesRoutes);
// filesRoutes is a sub-router mounted on repos since paths are /repos/:id/files
app.route("/repos", filesRoutes);
```
Note: filesRoutes handlers define paths relative to mount point. Since repos routes already exist at `/repos`, the files routes should be ADDED to the existing reposRoutes file, OR mounted as a separate sub-app. Recommended: add file routes directly to `apps/daemon/src/routes/repos.ts` since they share the `/repos` prefix. Alternatively, create files.ts with full `/:repoId/files` paths and mount alongside existing repos routes. Choose whichever avoids route conflicts.

Also add a `GET /stats` handler (either in health.ts or a new stats route):
- Returns `{ repos_count, total_files, total_chunks, uptime_seconds }`
- `repos_count`: count from repos table
- `total_files`: count from file_metadata table
- `total_chunks`: count from chunks table
- `uptime_seconds`: `Math.floor(process.uptime())`
  </action>
  <verify>
1. `pnpm --filter @lens/core build` succeeds
2. `pnpm --filter @lens/daemon build` succeeds
3. grep for `getTraceStore` in core/src/index.ts confirms export
4. grep for `tracesRoutes` in daemon/src/http.ts confirms route mount
  </verify>
  <done>
TraceStore has queryTraces/querySpans methods. getTraceStore singleton exported from @lens/core. Daemon has GET /traces, GET /traces/:id, GET /repos/:id/files, GET /repos/:id/files/:path, and GET /stats routes. All builds pass.
  </done>
</task>

</tasks>

<verification>
- `pnpm -r build` — all packages build clean
- `apps/dashboard/dist/index.html` exists after build
- Dashboard imports all shared components from @lens/ui (no local ui/ dir)
- Overview page renders with stat cards
- Daemon has trace, file, and stats routes
- Core exports getTraceStore
</verification>

<success_criteria>
Dashboard has v1-matching layout shell with sidebar (AppSidebar from @lens/ui), Overview page with stat cards and repo grid (Card/PageHeader from @lens/ui). Daemon has all API endpoints the dashboard needs (traces, files, stats). Both dashboard and daemon build clean.
</success_criteria>

<output>
After completion, create `.planning/phases/03-cli-dashboard/03-04-SUMMARY.md`
</output>
