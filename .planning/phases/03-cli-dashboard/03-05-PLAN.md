---
phase: 03-cli-dashboard
plan: 05
type: execute
wave: 3
depends_on: ["03-04"]
files_modified:
  - apps/dashboard/src/pages/Traces.tsx
  - apps/dashboard/src/components/TraceWaterfall.tsx
autonomous: true
requirements: [DASH-02]

must_haves:
  truths:
    - "Traces page shows a table of recent daemon requests with method, path, status, duration"
    - "Clicking a trace row opens a Sheet with trace waterfall showing spans as horizontal bars"
    - "Waterfall bars use cycled Tailwind colors (blue/emerald/amber/purple/rose/cyan/orange)"
    - "Each bar width is proportional to span duration relative to total trace duration, minimum 2%"
    - "Span labels shown on left in mono font, duration in ms shown on right"
    - "Error spans highlighted in destructive color"
    - "Spans are ordered by started_at with visual nesting via parentSpanId depth"
    - "All UI primitives (Sheet, PageHeader, Separator) imported from @lens/ui"
  artifacts:
    - path: "apps/dashboard/src/pages/Traces.tsx"
      provides: "Traces page with request log table and detail Sheet"
      min_lines: 80
    - path: "apps/dashboard/src/components/TraceWaterfall.tsx"
      provides: "Waterfall component rendering span bars"
      min_lines: 40
  key_links:
    - from: "apps/dashboard/src/pages/Traces.tsx"
      to: "apps/dashboard/src/queries/use-traces.ts"
      via: "useTraces() hook"
      pattern: "useTraces"
    - from: "apps/dashboard/src/pages/Traces.tsx"
      to: "@lens/ui"
      via: "import { Sheet, SheetContent, PageHeader, Separator }"
      pattern: "from.*@lens/ui"
    - from: "apps/dashboard/src/pages/Traces.tsx"
      to: "apps/dashboard/src/components/TraceWaterfall.tsx"
      via: "TraceWaterfall component"
      pattern: "TraceWaterfall"
    - from: "apps/dashboard/src/pages/Traces.tsx"
      to: "apps/dashboard/src/store/trace-store.ts"
      via: "selectTrace/useSelectedTraceId"
      pattern: "selectTrace|useSelectedTraceId"
---

<objective>
Build the trace waterfall viewer — request log table + span waterfall in a Sheet.

Purpose: Let users visualize daemon request traces with timing breakdown per span, matching the v1 Requests page design exactly.
Output: Traces page with request table, clickable rows opening trace detail Sheet with horizontal waterfall bars.
</objective>

<execution_context>
@/Users/jalipalo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jalipalo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-cli-dashboard/03-RESEARCH.md
@.planning/phases/03-cli-dashboard/03-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: TraceWaterfall component</name>
  <files>apps/dashboard/src/components/TraceWaterfall.tsx</files>
  <action>
Create `TraceWaterfall.tsx` — EXACT match of v1 trace waterfall design from `Requests.tsx`.

Component receives `spans` array (from `GET /traces/:traceId` response). Each span has: `spanId`, `parentSpanId`, `name`, `startedAt` (unix ms), `durationMs`, `errorMessage`.

**Span tree reconstruction:**
- Build depth map: for each span, walk up parentSpanId chain to compute depth (0 for root spans)
- Sort spans by `startedAt` to preserve visual order

**Bar rendering:**
- Compute `traceStart` (min startedAt) and `traceDuration` (max(startedAt + durationMs) - traceStart)
- For each span, render a row:
  - Left: mono label with span name, truncated to w-28, indented by `depth * 16px`
  - Center: relative bar container (`flex-1 h-4 rounded-sm bg-muted/50 overflow-hidden`)
  - Inside: colored bar with `left: ((startedAt - traceStart) / traceDuration * 100)%` and `width: max(durationMs / traceDuration * 100, 2)%`
  - Right: duration in ms, `w-14 text-right font-mono tabular-nums`

**Bar colors — cycle through v1 palette:**
```typescript
const BAR_COLORS = [
  "bg-blue-500", "bg-emerald-500", "bg-amber-500",
  "bg-purple-500", "bg-rose-500", "bg-cyan-500", "bg-orange-500",
];
```
Use `BAR_COLORS[index % BAR_COLORS.length]` with `opacity-80`.

**Error highlighting:** If `span.errorMessage` exists, use `bg-destructive` instead of the cycled color.

Wrap in a section with `<h4 className="mb-2 text-xs font-medium text-muted-foreground">Trace</h4>` and `<div className="space-y-1 rounded-md border bg-muted/30 p-3">`.

No @lens/ui imports needed — this is a dashboard-specific visualization component using only Tailwind classes.
  </action>
  <verify>
File exists with TraceWaterfall export. Grep for BAR_COLORS confirms color cycling.
  </verify>
  <done>
TraceWaterfall component renders span bars with cycled colors, proportional widths, depth indentation, error highlighting.
  </done>
</task>

<task type="auto">
  <name>Task 2: Traces page with request log table and detail Sheet</name>
  <files>
    apps/dashboard/src/pages/Traces.tsx
    apps/dashboard/src/router.tsx
  </files>
  <action>
Create `Traces.tsx` — Port v1 Requests page design, adapted for v2 data model.

**v2 data model difference:** v1 had a custom `logs` table with method/path/status/source/request_body/response_body. v2 uses TraceStore's `traces` table which has `trace_id`, `root_span_name`, `started_at`, `ended_at`, `duration_ms`. The trace list IS the request list — each daemon request produces one trace via `lensRoute()`.

**Import shared components from @lens/ui:**
```tsx
import { PageHeader, Sheet, SheetContent, SheetHeader, SheetTitle, SheetDescription, Separator } from "@lens/ui";
```

**Page structure (matching v1 Requests.tsx exactly):**

1. **PageHeader** (from @lens/ui) with "Traces" title text

2. **Request table** — raw `<table>` (NOT DataTable), dense layout matching v1:
   - Sticky thead with `bg-muted/60` headers
   - Columns: # (row number), Time (formatted), Route (root_span_name), Duration (ms)
   - Each row: `group cursor-pointer hover:bg-accent/30`
   - Click row -> select trace (use `selectTrace(traceId)` from trace-store)
   - Table cells use v1 styling: `border-b border-r border-border`, `px-3 py-1.5`, `font-mono tabular-nums` on numbers
   - Loading state: spinner (same as v1)
   - Empty state: "No traces recorded yet"

3. **Use `useTraces()` hook** for the trace list with `refetchInterval: 5_000`

4. **Detail Sheet** (Sheet from @lens/ui) — opens when `selectedTraceId` is set:
   - `<Sheet open={!!selectedTraceId} onOpenChange={...}>`
   - `<SheetContent side="right" className="overflow-y-auto sm:max-w-lg">`
   - SheetHeader: route name as SheetTitle (`font-mono text-sm`), duration as SheetDescription
   - Body: `<Separator />` then `<TraceWaterfall spans={spans} />`
   - Use `useTraceSpans(selectedTraceId)` for span data
   - Loading state: Spinner while spans load

5. **Update `router.tsx`** — wire the `/traces` route to the `Traces` component (replace placeholder).

Use TanStack Store for selected trace state — `useSelectedTraceId()` selector hook, `selectTrace()` mutator. This prevents re-renders on unrelated store changes.
  </action>
  <verify>
1. `pnpm --filter @lens/dashboard build` succeeds
2. `grep "@lens/ui" apps/dashboard/src/pages/Traces.tsx` confirms shared imports
3. Router includes `/traces` route pointing to Traces component
  </verify>
  <done>
Traces page shows request log table. Clicking a row opens Sheet (from @lens/ui) with TraceWaterfall showing span bars with timing. Design matches v1 Requests page. Build passes.
  </done>
</task>

</tasks>

<verification>
- `pnpm --filter @lens/dashboard build` passes
- Traces.tsx imports Sheet, PageHeader, Separator from @lens/ui
- Traces.tsx imports and uses TraceWaterfall component
- Traces.tsx imports and uses useTraces/useTraceSpans hooks
- Traces.tsx uses TanStack Store selectTrace/useSelectedTraceId
- Router maps /traces to Traces component
</verification>

<success_criteria>
Trace waterfall viewer complete — table of recent traces, clicking opens Sheet with horizontal span bars showing route -> spans -> sub-spans timing. Colors cycle through blue/emerald/amber/purple/rose/cyan/orange. Error spans use destructive color. All UI primitives from @lens/ui. Design matches v1.
</success_criteria>

<output>
After completion, create `.planning/phases/03-cli-dashboard/03-05-SUMMARY.md`
</output>
