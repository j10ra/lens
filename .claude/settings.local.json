{
  "hooks": {
    "PostToolUse": [
      {
        "matcher": "Edit|Write",
        "hooks": [
          {
            "type": "command",
            "command": "/Volumes/Drive/__x/RLM/.claude/hooks/post-edit.sh",
            "timeout": 30000
          }
        ]
      }
    ]
  },
  "permissions": {
    "allow": [
      "Bash(rlm:*)",
      "Bash(node:*)",
      "Bash(npm:*)",
      "Bash(git:*)",
      "Bash(echo:*)",
      "Bash(pkill:*)",
      "Bash(pgrep:*)",
      "Bash(kill:*)",
      "Bash(xargs:*)",
      "Bash(wc:*)",
      "Bash(basename:*)",
      "Bash(docker:*)",
      "Bash(python3:*)",
      "Bash(bash:*)",
      "Bash(psql:*)",
      "Bash(pip3:*)",
      "Bash(optimum-cli:*)",
      "Bash(huggingface-cli:*)",
      "Bash(for:*)",
      "Bash(do:*)",
      "Bash(done:*)",
      "Bash(while:*)",
      "Bash(jq:*)",
      "WebFetch(domain:*)",
      "Bash({)",
      "Bash(__NEW_LINE_86e2eded6109da25__ echo \"\")",
      "Bash(})",
      "Bash(REPO_ID=\"2513f6ab-645a-44ce-93ff-67a2d3d847f2\")",
      "WebFetch(domain:openrouter.ai)",
      "Bash(gh issue create --repo j10ra/lens --title \"EPIC: LENS — Local-First Distribution & Subscription Platform\" --label \"epic\" --body \"$\\(cat <<''EOF''\n# EPIC: LENS — Local-First Distribution & Subscription Platform\n\n**Goal**: Transform RLM from a Docker+Postgres dev setup into a distributable CLI tool \\(`npm install -g lens`\\) with MCP agent integration and a premium subscription layer.\n\n```\nlens start          → local daemon\nlens repo register  → index a repo\nlens context \"goal\" → context pack\nlens login          → unlock premium features\n```\n\n---\n\n## Architecture Overview\n\n### Layer 1 — Engine \\(Local-First\\)\nSQLite replaces Postgres. All data stored in `~/.lens/data.db`. Zero external dependencies.\n\n- [ ] Migrate DB layer from Postgres → SQLite \\(WAL mode\\)\n- [ ] Replace JSONB columns with JSON text\n- [ ] Replace pg_advisory_lock with SQLite file locking\n- [ ] Port all SQL queries \\(mostly portable, minor syntax diffs\\)\n- [ ] Store config/data in `~/.lens/`\n\n**Preserved**: TF-IDF scoring, import graph, co-change analysis, chunking, metadata extraction, vocab clusters, concept expansion, query interpreter.\n\n### Layer 2 — Local Daemon + Agent Integration\nLightweight HTTP server + MCP transport \\(stdio + JSON-RPC\\).\n\n- [ ] Replace Encore HTTP layer with lightweight framework \\(Hono\\)\n- [ ] Implement MCP server protocol \\(stdio transport\\)\n- [ ] `lens start` → background daemon on localhost:4111\n- [ ] `lens stop` → graceful shutdown\n- [ ] `lens init` → write .mcp.json for Claude Code auto-discovery\n- [ ] Dual transport: HTTP for CLI, stdio for MCP\n\n### Layer 3 — Cloud Control Plane \\(Subscription + Billing\\)\nSeparate cloud service. Handles auth, licensing, premium API proxying.\n\n- [ ] `lens login` → browser OAuth flow → ~/.lens/auth.json\n- [ ] License validation \\(daemon pings on startup, 24h offline cache\\)\n- [ ] Stripe integration \\(subscription billing, usage metering\\)\n- [ ] Voyage API proxy \\(premium users don''t need their own key\\)\n- [ ] OpenRouter proxy for purpose summaries\n- [ ] Usage dashboard / control panel\n- [ ] User profile management\n\n---\n\n## Distribution Strategy\n\n### Phase 1 — npm package\n- [ ] `npm install -g lens` with sql.js \\(wasm, zero native deps\\)\n- [ ] Works everywhere Node.js runs\n- [ ] Single package, no Docker, no Postgres\n\n### Phase 2 — Standalone binary\n- [ ] `bun build --compile` for users without Node.js\n- [ ] Cross-platform builds \\(macOS, Linux, Windows\\)\n- [ ] bun:sqlite for native performance\n\n---\n\n## Free vs Premium\n\n| Free | Premium \\(Subscription\\) |\n|---|---|\n| Full indexing \\(TF-IDF, imports, co-change\\) | Voyage embeddings \\(proxied\\) |\n| Context packs + MCP integration | Purpose summaries \\(proxied\\) |\n| Unlimited local repos | Vocab clusters |\n| Static synonym expansion | Priority support |\n| | Usage dashboard |\n\n---\n\n## Migration Order\n\n1. **SQLite DB layer** — everything depends on this\n2. **HTTP framework swap** \\(Encore → Hono\\)\n3. **MCP server** — agent integration\n4. **CLI restructure** — lens start/stop/login/init\n5. **Cloud control plane** — auth, billing, proxying\n6. **npm publish** — Phase 1 distribution\n7. **Bun compile** — Phase 2 standalone binary\n\n---\n\n_This epic will be broken into individual issues as we drill down into each layer._\nEOF\n\\)\")",
      "Bash(gh issue create --repo j10ra/lens --title \"Convert to pnpm monorepo structure\" --label \"epic\" --body \"$\\(cat <<''EOF''\n# Convert to pnpm Monorepo Structure\n\n**Parent**: #1\n\nBefore any Layer 1/2/3 work begins, restructure the repo as a pnpm workspace monorepo. The current Encore app moves into `apps/encore/` and continues working as-is during migration.\n\n---\n\n## Target Structure\n\n```\nlens/\n├── pnpm-workspace.yaml\n├── package.json              ← root \\(private, scripts, devDeps\\)\n├── tsconfig.base.json        ← shared compiler options\n├── .gitignore\n├── CLAUDE.md\n│\n├── apps/\n│   ├── encore/               ← current Encore app \\(moved here as-is\\)\n│   │   ├── encore.app\n│   │   ├── package.json\n│   │   ├── tsconfig.json\n│   │   ├── repo/             \\(service: repos, DB, health\\)\n│   │   ├── index/            \\(service: indexing, embeddings\\)\n│   │   └── context/          \\(service: context packs\\)\n│   │\n│   ├── daemon/               ← Layer 2: local HTTP + MCP server \\(NEW, later\\)\n│   │   ├── package.json\n│   │   └── src/\n│   │\n│   └── cloud/                ← Layer 3: control plane \\(NEW, later\\)\n│       ├── encore.app\n│       ├── package.json\n│       └── src/\n│\n├── packages/\n│   ├── engine/               ← Layer 1: core logic, SQLite \\(NEW, later\\)\n│   │   ├── package.json\n│   │   └── src/\n│   │\n│   ├── cli/                  ← CLI: `lens` command \\(migrated from packages/rlm-cli\\)\n│   │   ├── package.json\n│   │   ├── tsconfig.json\n│   │   └── src/\n│   │\n│   └── types/                ← shared types/interfaces \\(NEW, later\\)\n│       ├── package.json\n│       └── src/\n```\n\n---\n\n## What Moves Where\n\n| Current location | New location | Notes |\n|---|---|---|\n| `repo/`, `index/`, `context/` | `apps/encore/` | Encore services — move with `encore.app`, `tsconfig.json`, root `package.json` deps |\n| `packages/rlm-cli/` | `packages/cli/` | Rename rlm → lens, update bin name |\n| `encore.app` | `apps/encore/encore.app` | Encore resolves relative to this file |\n| `encore.gen/` | `apps/encore/encore.gen/` | Auto-generated, gitignored |\n| `node_modules/` | root + per-package \\(pnpm hoisting\\) | pnpm handles this |\n| `CLAUDE.md`, `README.md`, docs | root | Stay at repo root |\n\n---\n\n## Implementation Steps\n\n- [ ] Install pnpm globally if needed\n- [ ] Create root `package.json` \\(private, workspaces config\\)\n- [ ] Create `pnpm-workspace.yaml` defining `apps/*` and `packages/*`\n- [ ] Create `tsconfig.base.json` \\(shared config, project references\\)\n- [ ] Move Encore app → `apps/encore/` \\(services, migrations, encore.app, package.json, tsconfig\\)\n- [ ] Move CLI → `packages/cli/` \\(rename bin from `rlm` to `lens`\\)\n- [ ] Create stub `packages/engine/` \\(package.json only — placeholder for Layer 1\\)\n- [ ] Create stub `packages/types/` \\(package.json only — placeholder for shared types\\)\n- [ ] Create stub `apps/daemon/` \\(package.json only — placeholder for Layer 2\\)\n- [ ] Create stub `apps/cloud/` \\(package.json only — placeholder for Layer 3\\)\n- [ ] Update `.gitignore` for pnpm \\(node_modules at every level\\)\n- [ ] Verify `encore run` still works from `apps/encore/`\n- [ ] Verify CLI builds from `packages/cli/`\n- [ ] Run `pnpm install` from root — everything resolves\n\n---\n\n## Notes\n\n- `apps/encore/` is the **working reference** during migration. It stays functional until Layer 1 \\(engine\\) + Layer 2 \\(daemon\\) fully replace it.\n- Stub packages \\(`engine`, `types`, `daemon`, `cloud`\\) are empty placeholders — just `package.json` with name/version. We populate them in later issues.\n- pnpm strict hoisting prevents phantom deps — each package declares its own dependencies.\n- Root scripts: `pnpm -r build`, `pnpm --filter cli build`, `pnpm --filter encore dev`\nEOF\n\\)\")",
      "Bash(gh issue close:*)",
      "Bash(gh issue view:*)",
      "WebFetch(domain:dev.to)",
      "WebFetch(domain:mcpcat.io)",
      "WebFetch(domain:github.com)",
      "WebFetch(domain:raw.githubusercontent.com)",
      "Bash(gh issue edit:*)",
      "Bash(LENS_HOST=\"http://127.0.0.1:4111\" node:*)",
      "WebFetch(domain:orm.drizzle.team)",
      "WebFetch(domain:www.npmjs.com)",
      "Bash(gh issue create:*)",
      "Bash(gh api:*)",
      "Bash(lens:*)",
      "mcp__supabase__get_project_url",
      "mcp__supabase__list_tables",
      "mcp__supabase__get_publishable_keys",
      "mcp__supabase__search_docs",
      "mcp__supabase__execute_sql",
      "Bash(gh issue list:*)",
      "Bash(gh issue comment:*)",
      "WebFetch(domain:localhost)",
      "mcp__lens__get_context"
    ]
  }
}
